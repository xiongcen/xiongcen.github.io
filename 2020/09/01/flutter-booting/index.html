<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>深入理解Flutter引擎启动 | Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="&amp;#x6458;&amp;#x8981;Flutter&amp;#x5F15;&amp;#x64CE;&amp;#x542F;&amp;#x52A8;&amp;#x6E90;&amp;#x7801;&amp;#x8BE6;&amp;#x89E3;&amp;#x3002;">
<meta property="og:type" content="article">
<meta property="og:title" content="深入理解Flutter引擎启动">
<meta property="og:url" content="http://yoursite.com/2020/09/01/flutter-booting/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="&amp;#x6458;&amp;#x8981;Flutter&amp;#x5F15;&amp;#x64CE;&amp;#x542F;&amp;#x52A8;&amp;#x6E90;&amp;#x7801;&amp;#x8BE6;&amp;#x89E3;&amp;#x3002;">
<meta property="og:image" content="http://yoursite.com/2020/09/01/flutter-booting/Flutter_System_OverView.webp">
<meta property="og:image" content="http://yoursite.com/2020/09/01/flutter-booting/flutter_engine_startup.png">
<meta property="og:updated_time" content="2020-08-31T16:43:12.208Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="深入理解Flutter引擎启动">
<meta name="twitter:description" content="&amp;#x6458;&amp;#x8981;Flutter&amp;#x5F15;&amp;#x64CE;&amp;#x542F;&amp;#x52A8;&amp;#x6E90;&amp;#x7801;&amp;#x8BE6;&amp;#x89E3;&amp;#x3002;">
<meta name="twitter:image" content="http://yoursite.com/2020/09/01/flutter-booting/Flutter_System_OverView.webp">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-flutter-booting" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/09/01/flutter-booting/" class="article-date">
  <time datetime="2020-08-31T16:07:26.000Z" itemprop="datePublished">2020-09-01</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Flutter/">Flutter</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      深入理解Flutter引擎启动
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h5 id="&#x6458;&#x8981;"><a href="#&#x6458;&#x8981;" class="headerlink" title="&#x6458;&#x8981;"></a>&#x6458;&#x8981;</h5><p>Flutter&#x5F15;&#x64CE;&#x542F;&#x52A8;&#x6E90;&#x7801;&#x8BE6;&#x89E3;&#x3002;</p>
<a id="more"></a>
<h2 id="Flutter&#x6280;&#x672F;&#x67B6;&#x6784;&#x6982;&#x89C8;"><a href="#Flutter&#x6280;&#x672F;&#x67B6;&#x6784;&#x6982;&#x89C8;" class="headerlink" title="Flutter&#x6280;&#x672F;&#x67B6;&#x6784;&#x6982;&#x89C8;"></a>Flutter&#x6280;&#x672F;&#x67B6;&#x6784;&#x6982;&#x89C8;</h2><p>Flutter&#x5B98;&#x65B9;&#x56FE;&#x5206;&#x4E3A;&#x4E09;&#x5C42;&#xFF0C;&#x9664;&#x4E86;Framework&#x3001;Engine&#x3001;Embedder&#x4E09;&#x5C42;&#x5916;&#xFF0C;&#x5176;&#x5B9E;&#x8FD8;&#x6709;&#x4E00;&#x5C42;&#x5373;&#x6211;&#x4EEC;&#x5728;&#x6700;&#x4E0A;&#x5C42;&#x7F16;&#x5199;&#x7684;Dart&#x4EE3;&#x7801;&#x3002;</p>
<p><img src="/2020/09/01/flutter-booting/Flutter_System_OverView.webp" alt="Flutter System OverView"></p>
<ol>
<li>Framework(Dart)&#xFF1A;&#x7528;Dart&#x7F16;&#x5199;&#xFF0C;&#x5C01;&#x88C5;&#x6574;&#x4E2A;Flutter&#x67B6;&#x6784;&#x7684;&#x6838;&#x5FC3;&#x529F;&#x80FD;&#xFF0C;&#x5305;&#x62EC;Widget&#x3001;&#x52A8;&#x753B;&#x3001;&#x7ED8;&#x5236;&#x3001;&#x624B;&#x52BF;&#x7B49;&#x529F;&#x80FD;&#xFF0C;&#x6709;Material&#xFF08;Android&#x98CE;&#x683C;UI&#xFF09;&#x548C;Cupertino&#xFF08;iOS&#x98CE;&#x683C;&#xFF09;&#x7684;UI&#x754C;&#x9762;&#xFF0C; &#x53EF;&#x6784;&#x5EFA;Widget&#x63A7;&#x4EF6;&#x4EE5;&#x53CA;&#x5B9E;&#x73B0;UI&#x5E03;&#x5C40;&#xFF1B;</li>
<li>Engine(C/C++)&#xFF1A;&#x7528;C++&#x7F16;&#x5199;&#xFF0C;&#x5B9E;&#x73B0;&#x4E86;Flutter&#x7684;&#x6838;&#x5FC3;&#x5E93;&#xFF0C;&#x5305;&#x62EC;Dart&#x865A;&#x62DF;&#x673A;&#x3001;&#x52A8;&#x753B;&#x548C;&#x56FE;&#x5F62;&#x3001;&#x6587;&#x5B57;&#x6E32;&#x67D3;&#x3001;&#x901A;&#x4FE1;&#x901A;&#x9053;&#x3001;&#x4E8B;&#x4EF6;&#x901A;&#x77E5;&#x3001;&#x63D2;&#x4EF6;&#x67B6;&#x6784;&#x7B49;&#x3002;&#x5F15;&#x64CE;&#x6E32;&#x67D3;&#x91C7;&#x7528;&#x7684;&#x662F;2D&#x56FE;&#x5F62;&#x6E32;&#x67D3;&#x5E93;Skia&#xFF0C;&#x865A;&#x62DF;&#x673A;&#x91C7;&#x7528;&#x7684;&#x662F;&#x9762;&#x5411;&#x5BF9;&#x8C61;&#x8BED;&#x8A00;Dart VM&#xFF0C;&#x5E76;&#x5C06;&#x5B83;&#x4EEC;&#x6258;&#x7BA1;&#x5230;&#x5E73;&#x53F0;&#x7684;&#x4E2D;&#x95F4;&#x5C42;&#x4EE3;&#x7801;(Embedder);</li>
<li>Embedder(Platform Specific)&#xFF1A;&#x5D4C;&#x5165;&#x5C42;&#xFF0C;&#x4E3A;Engine&#x521B;&#x5EFA;&#x548C;&#x7BA1;&#x7406;&#x7EBF;&#x7A0B;&#xFF0C;&#x4F5C;&#x7528;&#x662F;&#x628A;Engine&#x7684;Task Runners&#xFF08;&#x4EFB;&#x52A1;&#x8FD0;&#x884C;&#x5668;&#xFF09;&#x8FD0;&#x884C;&#x5728;&#x5D4C;&#x5165;&#x5C42;&#x7BA1;&#x7406;&#x7684;&#x7EBF;&#x7A0B;&#x4E0A;&#x3002;</li>
</ol>
<blockquote>
<p>&#x5B9E;&#x73B0; Embedder API &#x7684;&#x53EB;&#x505A; shell &#xFF0C;shell&#x5B9E;&#x73B0;&#x4E86;&#x5E73;&#x53F0;&#x76F8;&#x5173;&#x7684;&#x4EE3;&#x7801;&#xFF0C;&#x6BD4;&#x5982;&#x8DDF;&#x5C4F;&#x5E55;&#x952E;&#x76D8;IME&#x548C;&#x7CFB;&#x7EDF;&#x5E94;&#x7528;&#x751F;&#x547D;&#x5468;&#x671F;&#x4E8B;&#x4EF6;&#x7684;&#x4EA4;&#x4E92;&#x3002;&#x4E0D;&#x540C;&#x5E73;&#x53F0;&#x6709;&#x4E0D;&#x540C;&#x7684;shell&#xFF0C;&#x6BD4;&#x5982;Android&#x548C;iOS&#x7684;shell&#x3002;</p>
</blockquote>
<h2 id="Flutter&#x5F15;&#x64CE;&#x542F;&#x52A8;-&#x57FA;&#x4E8E;Flutter-1-17-5-&#x5206;&#x6790;"><a href="#Flutter&#x5F15;&#x64CE;&#x542F;&#x52A8;-&#x57FA;&#x4E8E;Flutter-1-17-5-&#x5206;&#x6790;" class="headerlink" title="Flutter&#x5F15;&#x64CE;&#x542F;&#x52A8;[&#x57FA;&#x4E8E;Flutter 1.17.5 &#x5206;&#x6790;]"></a>Flutter&#x5F15;&#x64CE;&#x542F;&#x52A8;[&#x57FA;&#x4E8E;Flutter 1.17.5 &#x5206;&#x6790;]</h2><p><img src="/2020/09/01/flutter-booting/flutter_engine_startup.png" alt=""></p>
<p>&#x8FD9;&#x91CC;&#x4EE5;Android&#x4E3A;&#x4F8B;&#xFF0C;APP&#x542F;&#x52A8;&#x8FC7;&#x7A0B;&#xFF0C;&#x4F1A;&#x6267;&#x884C;Application&#x548C;Activity&#x7684;onCreate()&#x65B9;&#x6CD5;&#xFF0C;FlutterApplication&#x548C;FlutterActivity&#x7684;onCreate()&#x65B9;&#x6CD5;&#x6B63;&#x662F;&#x8FDE;&#x63A5;Native&#x548C;Flutter&#x7684;&#x67A2;&#x7EBD;&#x3002;</p>
<ul>
<li>FlutterApplication.java&#x7684;onCreate&#x8FC7;&#x7A0B;&#x4E3B;&#x8981;&#x5B8C;&#x6210;&#x521D;&#x59CB;&#x5316;&#x914D;&#x7F6E;&#x3001;&#x52A0;&#x8F7D;&#x5F15;&#x64CE;libflutter.so&#x3001;&#x6CE8;&#x518C;JNI&#x65B9;&#x6CD5;&#xFF1B;</li>
<li>FlutterActivity.java&#x7684;onCreate&#x8FC7;&#x7A0B;&#xFF0C;&#x901A;&#x8FC7;FlutterJNI&#x7684;AttachJNI()&#x65B9;&#x6CD5;&#x6765;&#x521D;&#x59CB;&#x5316;&#x5F15;&#x64CE;Engine&#x3001;Dart&#x865A;&#x62DF;&#x673A;&#x3001;Isolate&#x3001;taskRunner&#x7B49;&#x5BF9;&#x8C61;&#x3002;&#x518D;&#x7ECF;&#x8FC7;&#x5C42;&#x5C42;&#x5904;&#x7406;&#x6700;&#x7EC8;&#x8C03;&#x7528;main.dart&#x4E2D;main()&#x65B9;&#x6CD5;&#xFF0C;&#x6267;&#x884C;runApp(Widget app)&#x6765;&#x5904;&#x7406;&#x6574;&#x4E2A;Dart&#x4E1A;&#x52A1;&#x4EE3;&#x7801;&#x3002;</li>
</ul>
<h3 id="1-FlutterApplication&#x542F;&#x52A8;"><a href="#1-FlutterApplication&#x542F;&#x52A8;" class="headerlink" title="1.FlutterApplication&#x542F;&#x52A8;"></a>1.FlutterApplication&#x542F;&#x52A8;</h3><p>&#x5728;AndrodManifest.xml&#x5B9A;&#x4E49;&#x7684;FlutterApplication&#xFF0C;Android&#x5E94;&#x7528;&#x5728;&#x542F;&#x52A8;&#x65F6;&#x5019;&#x4F1A;&#x6267;&#x884C;FlutterApplication.onCreate()&#xFF0C;&#x7136;&#x540E;&#x518D;&#x6267;&#x884C;FlutterMain.startInitialization()&#x65B9;&#x6CD5;&#xFF0C;&#x5176;&#x4E3B;&#x8981;&#x5DE5;&#x4F5C;&#xFF1A;</p>
<ol>
<li>&#x786E;&#x4FDD;&#x8BE5;&#x65B9;&#x6CD5;&#x5FC5;&#x987B;&#x8FD0;&#x884C;&#x5728;&#x4E3B;&#x7EBF;&#x7A0B;&#xFF0C;&#x5426;&#x5219;&#x629B;&#x51FA;&#x5F02;&#x5E38;&#xFF1B;</li>
<li>&#x521D;&#x59CB;&#x5316;FlutterLoader&#x7684;&#x76F8;&#x5173;&#x914D;&#x7F6E;&#x4FE1;&#x606F;flutter_assets&#x3001;vm_snapshot_data&#x3001;isolate_snapshot_data&#x7B49;&#xFF0C;&#x5F53;metadata&#x6570;&#x636E;&#x6CA1;&#x6709;&#x914D;&#x7F6E;&#x521D;&#x59CB;&#x503C;&#x65F6;&#x5219;&#x91C7;&#x7528;&#x9ED8;&#x8BA4;&#x503C;&#xFF1B;</li>
<li>&#x6587;&#x4EF6;&#x6E05;&#x7406;&#x3001;&#x63D0;&#x53D6;&#x8D44;&#x6E90;(&#x4F8B;&#x5982;&#x5E94;&#x7528;&#x6839;&#x76EE;&#x5F55;&#x4E0B;&#x7684;&#x6240;&#x6709;assets&#x8D44;&#x6E90;&#x7B49;)&#x52A0;&#x8F7D;&#x5230;&#x5185;&#x5B58;&#xFF0C;&#x8FD9;&#x4E2A;&#x8FC7;&#x7A0B;&#x90FD;&#x662F;&#x5728;&#x5F02;&#x6B65;&#x7EBF;&#x7A0B;&#x6267;&#x884C;&#x5B8C;&#x6210;&#xFF1B;</li>
<li>&#x52A0;&#x8F7D;libflutter.so&#x5E93;&#xFF0C;&#x65E0;&#x8BBA;&#x662F;System.loadLibrary()&#xFF0C;&#x8FD8;&#x662F;System.load()&#x6700;&#x7EC8;&#x90FD;&#x4F1A;&#x8C03;&#x7528;&#x5230;&#x8BE5;&#x52A0;&#x8F7D;&#x5E93;&#x4E2D;&#x7684;JNI_OnLoad() <a href="https://github.com/flutter/engine/blob/flutter-1.17-candidate.5/shell/platform/android/library_loader.cc" target="_blank" rel="external">-&gt; flutter/shell/platform/android/library_loader.cc</a>&#xFF1A;<ol>
<li>Android&#x8FDB;&#x7A0B;&#x5728;&#x7531;zygote fork&#x8FC7;&#x7A0B;&#x4E2D;&#x5DF2;&#x521B;&#x5EFA;&#x4E86;JavaVM&#xFF0C;&#x6BCF;&#x4E00;&#x4E2A;&#x8FDB;&#x7A0B;&#x5BF9;&#x5E94;&#x4E00;&#x4E2A;JavaVM&#x3002;&#x5728;&#x8FD9;&#x91CC;&#x53EA;&#x662F;&#x5C06;&#x5F53;&#x524D;&#x8FDB;&#x7A0B;&#x7684;JavaVM&#x5B9E;&#x4F8B;&#x4FDD;&#x5B58;&#x5728;&#x9759;&#x6001;&#x53D8;&#x91CF;&#xFF0C;&#x518D;&#x5C06;&#x5F53;&#x524D;&#x7EBF;&#x7A0B;&#x548C;JavaVM&#x5EFA;&#x7ACB;&#x5173;&#x8054;&#xFF0C;&#x83B7;&#x53D6;JNIEnv&#x5B9E;&#x4F8B;&#xFF0C;&#x6BCF;&#x4E2A;&#x7EBF;&#x7A0B;&#x5BF9;&#x5E94;&#x4E00;&#x4E2A;JNIEnv&#x5B9E;&#x4F8B; <a href="https://github.com/flutter/engine/blob/flutter-1.17-candidate.5/fml/platform/android/jni_util.cc" target="_blank" rel="external">-&gt; flutter/fml/platform/android/jni_util.cc</a> </li>
<li>&#x6CE8;&#x518C;FlutterJNI&#x7684;JNI&#x65B9;&#x6CD5;&#xFF0C;nativeInit()&#x548C;nativeRecordStartTimestamp() <a href="https://github.com/flutter/engine/blob/flutter-1.17-candidate.5/shell/platform/android/flutter_main.cc" target="_blank" rel="external">-&gt; flutter/shell/platform/android/flutter_main.cc</a></li>
<li>&#x6CE8;&#x518C;PlatformViewAndroid&#x7684;&#x4E00;&#x7CFB;&#x5217;&#x65B9;&#x6CD5;,&#x5B8C;&#x6210;Java&#x548C;C++&#x7684;&#x4E00;&#x4E9B;&#x65B9;&#x6CD5;&#x4E92;&#x8C03; <a href="https://github.com/flutter/engine/blob/flutter-1.17-candidate.5/shell/platform/android/platform_view_android_jni.cc" target="_blank" rel="external">-&gt; flutter/shell/platform/android/platform_view_android_jni.cc</a>&#xFF1A;<ul>
<li>&#x901A;&#x8FC7;RegisterNatives()&#x65B9;&#x6CD5;&#x6CE8;&#x518C;&#x4E00;&#x4E9B;&#x7C7B;&#x7684;Native&#x65B9;&#x6CD5;&#xFF0C;&#x7528;&#x4E8E;Java&#x8C03;&#x7528;C++&#x7684;&#x8FC7;&#x7A0B;&#xFF1B;</li>
<li>&#x901A;&#x8FC7;GetMethodID()&#x65B9;&#x6CD5;&#x8BB0;&#x5F55;&#x4E86;&#x4E00;&#x4E9B;&#x7C7B;&#x7684;Java&#x65B9;&#x6CD5;&#x7684;jmethodID&#xFF0C;&#x7528;&#x4E8E;C++&#x8C03;&#x7528;Java&#x7684;&#x8FC7;&#x7A0B;&#xFF1B;</li>
</ul>
</li>
<li>&#x6CE8;&#x518C;FlutterJNI&#x7684;nativeOnVsync()&#x7528;&#x4E8E;Java&#x8C03;&#x7528;C++&#xFF0C;asyncWaitForVsync()&#x7528;&#x4E8E;C++&#x8C03;&#x7528;Java <a href="https://github.com/flutter/engine/blob/flutter-1.17-candidate.5/shell/platform/android/vsync_waiter_android.cc" target="_blank" rel="external">-&gt; flutter/shell/platform/android/vsync_waiter_android.cc</a>&#xFF1B;</li>
</ol>
</li>
<li>&#x6700;&#x7EC8;&#x901A;&#x8FC7;engine_main_enter_ts&#x53D8;&#x91CF;&#x8BB0;&#x5F55;FlutterApplication&#x7684;&#x542F;&#x52A8;&#x8017;&#x65F6; <a href="https://github.com/flutter/engine/blob/flutter-1.17-candidate.5/shell/platform/android/flutter_main.cc" target="_blank" rel="external">-&gt; flutter/shell/platform/android/flutter_main.cc</a></li>
</ol>
<h3 id="2-FlutterActivity&#x542F;&#x52A8;"><a href="#2-FlutterActivity&#x542F;&#x52A8;" class="headerlink" title="2.FlutterActivity&#x542F;&#x52A8;"></a>2.FlutterActivity&#x542F;&#x52A8;</h3><p>&#x6BCF;&#x4E00;&#x4E2A;FlutterActivity&#x90FD;&#x4F1A;&#x5BF9;&#x5E94;&#x4E00;&#x4E2A;FlutterActivityAndFragmentDelegate&#x4EE3;&#x7406;&#x7C7B;&#xFF0C;FlutterActivity&#x7684;&#x5DE5;&#x4F5C;&#x5168;&#x6743;&#x59D4;&#x6258;&#x7ED9;FlutterActivityAndFragmentDelegate&#x7C7B;&#xFF0C;&#x5305;&#x62EC;onCreate()&#xFF0C;onResume()&#x7B49;&#x5168;&#x90E8;&#x7684;&#x751F;&#x547D;&#x5468;&#x671F;&#x56DE;&#x8C03;&#x65B9;&#x6CD5;&#x3002;</p>
<h4 id="2-1-FlutterActivity-onCreate"><a href="#2-1-FlutterActivity-onCreate" class="headerlink" title="2.1 FlutterActivity#onCreate"></a>2.1 FlutterActivity#onCreate</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(@Nullable Bundle savedInstanceState)</span> </span>{</div><div class="line">    <span class="comment">// &#x67E5;&#x770B;&#x662F;&#x5426;&#x6709;&#x914D;&#x7F6E;&#x4E3B;&#x9898;</span></div><div class="line">    <span class="keyword">this</span>.switchLaunchThemeForNormalTheme();</div><div class="line">    <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">    <span class="keyword">this</span>.lifecycle.handleLifecycleEvent(Event.ON_CREATE);</div><div class="line">    <span class="comment">// &#x521D;&#x59CB;&#x5316;delegate</span></div><div class="line">    <span class="keyword">this</span>.delegate = <span class="keyword">new</span> FlutterActivityAndFragmentDelegate(<span class="keyword">this</span>);</div><div class="line">    <span class="comment">// &#x521D;&#x59CB;&#x5316;Flutter Engine&#x76F8;&#x5173;&#xFF0C;&#x63A5;&#x4E0B;&#x6765;&#x8BE6;&#x7EC6;&#x5206;&#x6790;[&#x89C1;2.2]</span></div><div class="line">    <span class="keyword">this</span>.delegate.onAttach(<span class="keyword">this</span>);</div><div class="line">    <span class="comment">// &#x6062;&#x590D;&#x72B6;&#x6001;onRestoreInstanceState&#x7684;&#x8C03;&#x7528;</span></div><div class="line">    <span class="keyword">this</span>.delegate.onActivityCreated(savedInstanceState);</div><div class="line">    <span class="comment">// &#x5F53;Intent&#x914D;&#x7F6E;&#x7684;backgroundMode&#x662F;&#x900F;&#x660E;&#x65F6;&#xFF0C;&#x5C31;&#x914D;&#x7F6E;window&#x900F;&#x660E;</span></div><div class="line">    <span class="keyword">this</span>.configureWindowForTransparency();</div><div class="line">    <span class="comment">// &#x521B;&#x5EFA;FlutterView&#xFF0C;&#x5B9E;&#x9645;&#x4E0A;&#x662F;&#x8C03;&#x7528;delegate#onCreateView&#xFF0C;&#x63A5;&#x4E0B;&#x6765;&#x8BE6;&#x7EC6;&#x5206;&#x6790;[&#x89C1;2.3]</span></div><div class="line">    <span class="keyword">this</span>.setContentView(<span class="keyword">this</span>.createFlutterView());</div><div class="line">    <span class="keyword">this</span>.configureStatusBarForFullscreenFlutterExperience();</div><div class="line">}</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onStart</span><span class="params">()</span> </span>{</div><div class="line">    <span class="keyword">super</span>.onStart();</div><div class="line">    <span class="keyword">this</span>.lifecycle.handleLifecycleEvent(Event.ON_START);</div><div class="line">    <span class="comment">// [&#x89C1;2.4]</span></div><div class="line">    <span class="keyword">this</span>.delegate.onStart();</div><div class="line">}</div></pre></td></tr></table></figure>
<h4 id="2-2-FlutterActivityAndFragmentDelegate-onAttach"><a href="#2-2-FlutterActivityAndFragmentDelegate-onAttach" class="headerlink" title="2.2 FlutterActivityAndFragmentDelegate#onAttach"></a>2.2 FlutterActivityAndFragmentDelegate#onAttach</h4><ol>
<li>&#x5F53;FlutterActivity&#x590D;&#x7528;&#x65F6;&#xFF0C;Flutter Engine&#x590D;&#x7528;&#xFF1B;&#x5426;&#x5219;<font color="red">&#x521D;&#x59CB;&#x5316;Flutter Engine[&#x8BE6;&#x89C1;3]</font>&#xFF0C;&#x521B;&#x5EFA;PlatformChannel&#x3001;FlutterEnginePluginRegistry&#x7B49;&#x5BF9;&#x8C61;</li>
<li>&#x5C06;Flutter Engine&#x9644;&#x52A0;&#x5230;FlutterActivity&#xFF0C;&#x4EE5;FlutterEnginePluginRegistry&#x4F5C;&#x4E3A;&#x6865;&#x63A5;&#x5A92;&#x4ECB;</li>
<li>&#x8C03;&#x7528;io.flutter.plugins.GeneratedPluginRegistrant#registerWith&#x65B9;&#x6CD5;&#xFF0C;&#x5B83;&#x662F;&#x81EA;&#x52A8;&#x751F;&#x6210;&#x7684;&#x7C7B;&#xFF0C;&#x4E0E;&#x6700;&#x4E0A;&#x5C42;&#x6211;&#x4EEC;&#x5199;&#x7684;Dart&#x4EE3;&#x7801;&#x63D2;&#x4EF6;&#x5173;&#x8054;</li>
</ol>
<h4 id="2-3-FlutterActivityAndFragmentDelegate-onCreateView"><a href="#2-3-FlutterActivityAndFragmentDelegate-onCreateView" class="headerlink" title="2.3 FlutterActivityAndFragmentDelegate#onCreateView"></a>2.3 FlutterActivityAndFragmentDelegate#onCreateView</h4><ol>
<li>&#x521B;&#x5EFA;FlutterView</li>
<li>&#x7ED9;FlutterView&#x6DFB;&#x52A0;&#x7B2C;&#x4E00;&#x5E27;&#x7ED8;&#x5236;&#x56DE;&#x8C03;</li>
<li>&#x521B;&#x5EFA;FlutterSplashView&#xFF0C;&#x5C06;FlutterView&#x4EA4;&#x7ED9;FlutterSplashView<br>&#x5C06;FlutterView&#x6302;&#x8F7D;&#x5230;Engine</li>
</ol>
<h4 id="2-4-FlutterActivityAndFragmentDelegate-onStart"><a href="#2-4-FlutterActivityAndFragmentDelegate-onStart" class="headerlink" title="2.4 FlutterActivityAndFragmentDelegate#onStart"></a>2.4 FlutterActivityAndFragmentDelegate#onStart</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">onStart</span><span class="params">()</span> </span>{</div><div class="line">    Log.v(<span class="string">&quot;FlutterActivityAndFragmentDelegate&quot;</span>, <span class="string">&quot;onStart()&quot;</span>);</div><div class="line">    <span class="keyword">this</span>.ensureAlive();</div><div class="line">    <span class="keyword">this</span>.doInitialFlutterViewRun();</div><div class="line">}</div></pre></td></tr></table></figure>
<h4 id="2-4-0-doInitialFlutterViewRun"><a href="#2-4-0-doInitialFlutterViewRun" class="headerlink" title="2.4.0 doInitialFlutterViewRun"></a>2.4.0 doInitialFlutterViewRun</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doInitialFlutterViewRun</span><span class="params">()</span> </span>{</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.host.getCachedEngineId() == <span class="keyword">null</span>) {</div><div class="line">        <span class="keyword">if</span> (!<span class="keyword">this</span>.flutterEngine.getDartExecutor().isExecutingDart()) {</div><div class="line">            Log.v(<span class="string">&quot;FlutterActivityAndFragmentDelegate&quot;</span>, <span class="string">&quot;Executing Dart entrypoint: &quot;</span> + <span class="keyword">this</span>.host.getDartEntrypointFunctionName() + <span class="string">&quot;, and sending initial route: &quot;</span> + <span class="keyword">this</span>.host.getInitialRoute());</div><div class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.host.getInitialRoute() != <span class="keyword">null</span>) {</div><div class="line">                <span class="keyword">this</span>.flutterEngine.getNavigationChannel().setInitialRoute(<span class="keyword">this</span>.host.getInitialRoute());</div><div class="line">            }</div><div class="line"></div><div class="line">            DartEntrypoint entrypoint = <span class="keyword">new</span> DartEntrypoint(<span class="keyword">this</span>.host.getAppBundlePath(), <span class="keyword">this</span>.host.getDartEntrypointFunctionName());</div><div class="line">            <span class="comment">// &#x89C1;[2.4.1]</span></div><div class="line">            <span class="keyword">this</span>.flutterEngine.getDartExecutor().executeDartEntrypoint(entrypoint);</div><div class="line">        }</div><div class="line">    }</div><div class="line">}</div></pre></td></tr></table></figure>
<p>&#x53C2;&#x6570;&#x4E2D;&#x7684;DartEntrypoint#dartEntrypointFunctionName&#x4EE3;&#x8868;&#x4E3B;&#x51FD;&#x6570;&#x5165;&#x53E3;&#x540D;&#xFF0C;DartEntrypoint#pathToBundle&#x4EE3;&#x8868;&#x5BF9;&#x5E94;&#x5E93;&#x7684;&#x8DEF;&#x5F84;&#xFF0C;dartEntrypointFunctionName&#x4E00;&#x822C;&#x90FD;&#x7B49;&#x4E8E;&#x201D;main&#x201D;&#x3002;</p>
<h4 id="2-4-1-DartExecutor-executeDartEntrypoint"><a href="#2-4-1-DartExecutor-executeDartEntrypoint" class="headerlink" title="2.4.1 DartExecutor#executeDartEntrypoint"></a>2.4.1 DartExecutor#executeDartEntrypoint</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// DartExecutor.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">executeDartEntrypoint</span><span class="params">(@NonNull DartExecutor.DartEntrypoint dartEntrypoint)</span> </span>{</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.isApplicationRunning) {</div><div class="line">        Log.w(<span class="string">&quot;DartExecutor&quot;</span>, <span class="string">&quot;Attempted to run a DartExecutor that is already running.&quot;</span>);</div><div class="line">    } <span class="keyword">else</span> {</div><div class="line">        Log.v(<span class="string">&quot;DartExecutor&quot;</span>, <span class="string">&quot;Executing Dart entrypoint: &quot;</span> + dartEntrypoint);</div><div class="line">        <span class="keyword">this</span>.flutterJNI.runBundleAndSnapshotFromLibrary(dartEntrypoint.pathToBundle, dartEntrypoint.dartEntrypointFunctionName, (String)<span class="keyword">null</span>, <span class="keyword">this</span>.assetManager);</div><div class="line">        <span class="keyword">this</span>.isApplicationRunning = <span class="keyword">true</span>;</div><div class="line">    }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">// FlutterJNI.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">runBundleAndSnapshotFromLibrary</span><span class="params">(@NonNull String bundlePath, @Nullable String entrypointFunctionName, @Nullable String pathToEntrypointFunction, @NonNull AssetManager assetManager)</span> </span>{</div><div class="line">    <span class="keyword">this</span>.ensureRunningOnMainThread();</div><div class="line">    <span class="keyword">this</span>.ensureAttachedToNative();</div><div class="line">    <span class="comment">// [&#x89C1;2.4.2]</span></div><div class="line">    <span class="keyword">this</span>.nativeRunBundleAndSnapshotFromLibrary(<span class="keyword">this</span>.nativePlatformViewId, bundlePath, entrypointFunctionName, pathToEntrypointFunction, assetManager);</div><div class="line">}</div></pre></td></tr></table></figure>
<h4 id="2-4-2-nativeRunBundleAndSnapshotFromLibrary"><a href="#2-4-2-nativeRunBundleAndSnapshotFromLibrary" class="headerlink" title="2.4.2 nativeRunBundleAndSnapshotFromLibrary"></a>2.4.2 nativeRunBundleAndSnapshotFromLibrary</h4><p>&#x8BE5;native&#x65B9;&#x6CD5;&#x5728;<br><a href="https://github.com/flutter/engine/blob/flutter-1.17-candidate.5/shell/platform/android/platform_view_android_jni.cc" target="_blank" rel="external">-&gt; flutter/shell/platform/android/platform_view_android_jni.cc</a>&#x4E2D;&#x6CE8;&#x518C;&#xFF0C;&#x5BF9;&#x5E94;&#x65B9;&#x6CD5;&#x540D;&#x4E3A;&#x201D;RunBundleAndSnapshotFromLibrary&#x201D;&#x3002;</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">#define ANDROID_SHELL_HOLDER \</div><div class="line">  (reinterpret_cast&lt;AndroidShellHolder*&gt;(shell_holder))</div><div class="line"></div><div class="line">static jlong AttachJNI(JNIEnv* env,</div><div class="line">                       jclass clazz,</div><div class="line">                       jobject flutterJNI,</div><div class="line">                       jboolean is_background_view) {</div><div class="line">  fml::jni::JavaObjectWeakGlobalRef java_object(env, flutterJNI);</div><div class="line">  auto shell_holder = std::make_unique&lt;AndroidShellHolder&gt;(</div><div class="line">      FlutterMain::Get().GetSettings(), java_object, is_background_view);</div><div class="line">  if (shell_holder-&gt;IsValid()) {</div><div class="line">    return reinterpret_cast&lt;jlong&gt;(shell_holder.release());</div><div class="line">  } else {</div><div class="line">    return 0;</div><div class="line">  }</div><div class="line">}</div><div class="line"></div><div class="line">static void RunBundleAndSnapshotFromLibrary(JNIEnv* env,</div><div class="line">                                            jobject jcaller,</div><div class="line">                                            jlong shell_holder,</div><div class="line">                                            jstring jBundlePath,</div><div class="line">                                            jstring jEntrypoint,</div><div class="line">                                            jstring jLibraryUrl,</div><div class="line">                                            jobject jAssetManager) {</div><div class="line">  auto asset_manager = std::make_shared&lt;flutter::AssetManager&gt;();</div><div class="line"></div><div class="line">  asset_manager-&gt;PushBack(std::make_unique&lt;flutter::APKAssetProvider&gt;(</div><div class="line">      env,                                             // jni environment</div><div class="line">      jAssetManager,                                   // asset manager</div><div class="line">      fml::jni::JavaStringToString(env, jBundlePath))  // apk asset dir</div><div class="line">  );</div><div class="line"></div><div class="line">  std::unique_ptr&lt;IsolateConfiguration&gt; isolate_configuration;</div><div class="line">  if (flutter::DartVM::IsRunningPrecompiledCode()) {</div><div class="line">    isolate_configuration = IsolateConfiguration::CreateForAppSnapshot();</div><div class="line">  } else {</div><div class="line">    std::unique_ptr&lt;fml::Mapping&gt; kernel_blob =</div><div class="line">        fml::FileMapping::CreateReadOnly(</div><div class="line">            ANDROID_SHELL_HOLDER-&gt;GetSettings().application_kernel_asset);</div><div class="line">    if (!kernel_blob) {</div><div class="line">      FML_DLOG(ERROR) &lt;&lt; &quot;Unable to load the kernel blob asset.&quot;;</div><div class="line">      return;</div><div class="line">    }</div><div class="line">    isolate_configuration =</div><div class="line">        IsolateConfiguration::CreateForKernel(std::move(kernel_blob));</div><div class="line">  }</div><div class="line"></div><div class="line">  RunConfiguration config(std::move(isolate_configuration),</div><div class="line">                          std::move(asset_manager));</div><div class="line"></div><div class="line">  {</div><div class="line">    auto entrypoint = fml::jni::JavaStringToString(env, jEntrypoint);</div><div class="line">    auto libraryUrl = fml::jni::JavaStringToString(env, jLibraryUrl);</div><div class="line"></div><div class="line">    if ((entrypoint.size() &gt; 0) &amp;&amp; (libraryUrl.size() &gt; 0)) {</div><div class="line">      config.SetEntrypointAndLibrary(std::move(entrypoint),</div><div class="line">                                     std::move(libraryUrl));</div><div class="line">    } else if (entrypoint.size() &gt; 0) {</div><div class="line">      config.SetEntrypoint(std::move(entrypoint));</div><div class="line">    }</div><div class="line">  }</div><div class="line">  // [&#x89C1;2.4.3]</div><div class="line">  ANDROID_SHELL_HOLDER-&gt;Launch(std::move(config));</div><div class="line">}</div></pre></td></tr></table></figure>
<h4 id="2-4-3-ANDROID-SHELL-HOLDER-gt-Launch"><a href="#2-4-3-ANDROID-SHELL-HOLDER-gt-Launch" class="headerlink" title="2.4.3 ANDROID_SHELL_HOLDER-&gt;Launch"></a>2.4.3 ANDROID_SHELL_HOLDER-&gt;Launch</h4><p><a href="https://github.com/flutter/engine/blob/flutter-1.17-candidate.5/shell/platform/android/android_shell_holder.cc" target="_blank" rel="external">-&gt; flutter/shell/platform/android/android_shell_holder.cc</a></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> AndroidShellHolder::Launch(RunConfiguration config) {</div><div class="line">  <span class="keyword">if</span> (!IsValid()) {</div><div class="line">    <span class="keyword">return</span>;</div><div class="line">  }</div><div class="line">  <span class="comment">// [&#x89C1;2.4.4]</span></div><div class="line">  shell_-&gt;RunEngine(<span class="built_in">std</span>::move(config));</div><div class="line">}</div></pre></td></tr></table></figure>
<h4 id="2-4-4-shell-gt-RunEngine"><a href="#2-4-4-shell-gt-RunEngine" class="headerlink" title="2.4.4 shell_-&gt;RunEngine"></a>2.4.4 shell_-&gt;RunEngine</h4><p><a href="https://github.com/flutter/engine/blob/flutter-1.17-candidate.5/shell/common/shell.cc" target="_blank" rel="external">-&gt; flutter/shell/common/shell.cc</a></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> Shell::RunEngine(RunConfiguration run_configuration) {</div><div class="line">  RunEngine(<span class="built_in">std</span>::move(run_configuration), <span class="literal">nullptr</span>);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">void</span> Shell::RunEngine(</div><div class="line">    RunConfiguration run_configuration,</div><div class="line">    <span class="keyword">const</span> <span class="built_in">std</span>::function&lt;<span class="keyword">void</span>(Engine::RunStatus)&gt;&amp; result_callback) {</div><div class="line">  <span class="keyword">auto</span> result = [platform_runner = task_runners_.GetPlatformTaskRunner(),</div><div class="line">                 result_callback](Engine::RunStatus run_result) {</div><div class="line">    <span class="keyword">if</span> (!result_callback) {</div><div class="line">      <span class="keyword">return</span>;</div><div class="line">    }</div><div class="line">    platform_runner-&gt;PostTask(</div><div class="line">        [result_callback, run_result]() { result_callback(run_result); });</div><div class="line">  };</div><div class="line">  FML_DCHECK(is_setup_);</div><div class="line">  FML_DCHECK(task_runners_.GetPlatformTaskRunner()-&gt;RunsTasksOnCurrentThread());</div><div class="line"></div><div class="line">  fml::TaskRunner::RunNowOrPostTask(</div><div class="line">      task_runners_.GetUITaskRunner(),</div><div class="line">      fml::MakeCopyable(</div><div class="line">          [run_configuration = <span class="built_in">std</span>::move(run_configuration),</div><div class="line">           weak_engine = weak_engine_, result]() <span class="keyword">mutable</span> {</div><div class="line">            <span class="keyword">if</span> (!weak_engine) {</div><div class="line">              FML_LOG(ERROR)</div><div class="line">                  &lt;&lt; <span class="string">&quot;Could not launch engine with configuration - no engine.&quot;</span>;</div><div class="line">              result(Engine::RunStatus::Failure);</div><div class="line">              <span class="keyword">return</span>;</div><div class="line">            }</div><div class="line">            <span class="comment">// [&#x89C1;2.4.5]</span></div><div class="line">            <span class="keyword">auto</span> run_result = weak_engine-&gt;Run(<span class="built_in">std</span>::move(run_configuration));</div><div class="line">            <span class="keyword">if</span> (run_result == flutter::Engine::RunStatus::Failure) {</div><div class="line">              FML_LOG(ERROR) &lt;&lt; <span class="string">&quot;Could not launch engine with configuration.&quot;</span>;</div><div class="line">            }</div><div class="line">            result(run_result);</div><div class="line">          }));</div><div class="line">}</div></pre></td></tr></table></figure>
<h4 id="2-4-5-weak-engine-gt-Run"><a href="#2-4-5-weak-engine-gt-Run" class="headerlink" title="2.4.5 weak_engine-&gt;Run"></a>2.4.5 weak_engine-&gt;Run</h4><p><a href="https://github.com/flutter/engine/blob/flutter-1.17-candidate.5/shell/common/engine.cc" target="_blank" rel="external">-&gt; flutter/shell/common/engine.cc</a></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line">Engine::RunStatus Engine::Run(RunConfiguration configuration) {</div><div class="line">  if (!configuration.IsValid()) {</div><div class="line">    FML_LOG(ERROR) &lt;&lt; &quot;Engine run configuration was invalid.&quot;;</div><div class="line">    return RunStatus::Failure;</div><div class="line">  }</div><div class="line"></div><div class="line">  last_entry_point_ = configuration.GetEntrypoint();</div><div class="line">  last_entry_point_library_ = configuration.GetEntrypointLibrary();</div><div class="line">  // [&#x89C1;2.4.6]</div><div class="line">  auto isolate_launch_status =</div><div class="line">      PrepareAndLaunchIsolate(std::move(configuration));</div><div class="line">  if (isolate_launch_status == Engine::RunStatus::Failure) {</div><div class="line">    FML_LOG(ERROR) &lt;&lt; &quot;Engine not prepare and launch isolate.&quot;;</div><div class="line">    return isolate_launch_status;</div><div class="line">  } else if (isolate_launch_status ==</div><div class="line">             Engine::RunStatus::FailureAlreadyRunning) {</div><div class="line">    return isolate_launch_status;</div><div class="line">  }</div><div class="line"></div><div class="line">  std::shared_ptr&lt;DartIsolate&gt; isolate =</div><div class="line">      runtime_controller_-&gt;GetRootIsolate().lock();</div><div class="line"></div><div class="line">  bool isolate_running =</div><div class="line">      isolate &amp;&amp; isolate-&gt;GetPhase() == DartIsolate::Phase::Running;</div><div class="line"></div><div class="line">  if (isolate_running) {</div><div class="line">    tonic::DartState::Scope scope(isolate.get());</div><div class="line"></div><div class="line">    if (settings_.root_isolate_create_callback) {</div><div class="line">      settings_.root_isolate_create_callback();</div><div class="line">    }</div><div class="line"></div><div class="line">    if (settings_.root_isolate_shutdown_callback) {</div><div class="line">      isolate-&gt;AddIsolateShutdownCallback(</div><div class="line">          settings_.root_isolate_shutdown_callback);</div><div class="line">    }</div><div class="line"></div><div class="line">    std::string service_id = isolate-&gt;GetServiceId();</div><div class="line">    fml::RefPtr&lt;PlatformMessage&gt; service_id_message =</div><div class="line">        fml::MakeRefCounted&lt;flutter::PlatformMessage&gt;(</div><div class="line">            kIsolateChannel,</div><div class="line">            std::vector&lt;uint8_t&gt;(service_id.begin(), service_id.end()),</div><div class="line">            nullptr);</div><div class="line">    HandlePlatformMessage(service_id_message);</div><div class="line">  }</div><div class="line"></div><div class="line">  return isolate_running ? Engine::RunStatus::Success</div><div class="line">                         : Engine::RunStatus::Failure;</div><div class="line">}</div></pre></td></tr></table></figure>
<h4 id="2-4-6-PrepareAndLaunchIsolate"><a href="#2-4-6-PrepareAndLaunchIsolate" class="headerlink" title="2.4.6 PrepareAndLaunchIsolate"></a>2.4.6 PrepareAndLaunchIsolate</h4><p><a href="https://github.com/flutter/engine/blob/flutter-1.17-candidate.5/shell/common/engine.cc" target="_blank" rel="external">-&gt; flutter/shell/common/engine.cc</a></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line">Engine::RunStatus Engine::PrepareAndLaunchIsolate(</div><div class="line">    RunConfiguration configuration) {</div><div class="line">  TRACE_EVENT0(<span class="string">&quot;flutter&quot;</span>, <span class="string">&quot;Engine::PrepareAndLaunchIsolate&quot;</span>);</div><div class="line"></div><div class="line">  UpdateAssetManager(configuration.GetAssetManager());</div><div class="line"></div><div class="line">  <span class="keyword">auto</span> isolate_configuration = configuration.TakeIsolateConfiguration();</div><div class="line"></div><div class="line">  <span class="built_in">std</span>::<span class="built_in">shared_ptr</span>&lt;DartIsolate&gt; isolate =</div><div class="line">      runtime_controller_-&gt;GetRootIsolate().lock();</div><div class="line"></div><div class="line">  <span class="keyword">if</span> (!isolate) {</div><div class="line">    <span class="keyword">return</span> RunStatus::Failure;</div><div class="line">  }</div><div class="line"></div><div class="line">  <span class="comment">// This can happen on iOS after a plugin shows a native window and returns to</span></div><div class="line">  <span class="comment">// the Flutter ViewController.</span></div><div class="line">  <span class="keyword">if</span> (isolate-&gt;GetPhase() == DartIsolate::Phase::Running) {</div><div class="line">    FML_DLOG(WARNING) &lt;&lt; <span class="string">&quot;Isolate was already running!&quot;</span>;</div><div class="line">    <span class="keyword">return</span> RunStatus::FailureAlreadyRunning;</div><div class="line">  }</div><div class="line"></div><div class="line">  <span class="keyword">if</span> (!isolate_configuration-&gt;PrepareIsolate(*isolate)) {</div><div class="line">    FML_LOG(ERROR) &lt;&lt; <span class="string">&quot;Could not prepare to run the isolate.&quot;</span>;</div><div class="line">    <span class="keyword">return</span> RunStatus::Failure;</div><div class="line">  }</div><div class="line"></div><div class="line">  <span class="keyword">if</span> (configuration.GetEntrypointLibrary().empty()) {</div><div class="line">    <span class="comment">// [&#x89C1;2.4.7]</span></div><div class="line">    <span class="keyword">if</span> (!isolate-&gt;Run(configuration.GetEntrypoint(),</div><div class="line">                      settings_.dart_entrypoint_args)) {</div><div class="line">      FML_LOG(ERROR) &lt;&lt; <span class="string">&quot;Could not run the isolate.&quot;</span>;</div><div class="line">      <span class="keyword">return</span> RunStatus::Failure;</div><div class="line">    }</div><div class="line">  } <span class="keyword">else</span> {</div><div class="line">    <span class="keyword">if</span> (!isolate-&gt;RunFromLibrary(configuration.GetEntrypointLibrary(),</div><div class="line">                                 configuration.GetEntrypoint(),</div><div class="line">                                 settings_.dart_entrypoint_args)) {</div><div class="line">      FML_LOG(ERROR) &lt;&lt; <span class="string">&quot;Could not run the isolate.&quot;</span>;</div><div class="line">      <span class="keyword">return</span> RunStatus::Failure;</div><div class="line">    }</div><div class="line">  }</div><div class="line"></div><div class="line">  <span class="keyword">return</span> RunStatus::Success;</div><div class="line">}</div></pre></td></tr></table></figure>
<p>&#x4ECE;configuration&#x4E2D;&#x83B7;&#x53D6;&#x4E3B;&#x51FD;&#x6570;&#x5165;&#x53E3;&#xFF0C;RunConfiguration&#x6709;&#x4E00;&#x4E2A;&#x6210;&#x5458;&#x53D8;&#x91CF;entrypoint_&#x503C;&#x7B49;&#x4E8E;&#x201C;main&#x201D;&#xFF0C; &#x8FD8;&#x6709;&#x4E00;&#x4E2A;&#x6210;&#x5458;&#x53D8;&#x91CF;entrypoint<em>library</em>&#xFF0C;&#x8FD9;&#x4E24;&#x4E2A;&#x53D8;&#x91CF;&#x8D4B;&#x503C;&#x7684;&#x8FC7;&#x7A0B;[&#x89C1;2.4.0]&#x3002;</p>
<h4 id="2-4-7-isolate-gt-Run"><a href="#2-4-7-isolate-gt-Run" class="headerlink" title="2.4.7 isolate-&gt;Run"></a>2.4.7 isolate-&gt;Run</h4><p><a href="https://github.com/flutter/engine/blob/flutter-1.17-candidate.5/runtime/dart_isolate.cc" target="_blank" rel="external">-&gt; flutter/runtime/dart_isolate.cc</a></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">[[nodiscard]] <span class="keyword">bool</span> DartIsolate::Run(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; entrypoint_name,</div><div class="line">                                    <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="built_in">std</span>::<span class="built_in">string</span>&gt;&amp; args,</div><div class="line">                                    <span class="keyword">const</span> fml::closure&amp; on_run) {</div><div class="line">  TRACE_EVENT0(<span class="string">&quot;flutter&quot;</span>, <span class="string">&quot;DartIsolate::Run&quot;</span>);</div><div class="line">  <span class="keyword">if</span> (phase_ != Phase::Ready) {</div><div class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">  }</div><div class="line"></div><div class="line">  tonic::DartState::<span class="function">Scope <span class="title">scope</span><span class="params">(<span class="keyword">this</span>)</span></span>;</div><div class="line"></div><div class="line">  <span class="comment">// &#x83B7;&#x53D6;&#x7528;&#x6237;&#x5165;&#x53E3;&#x51FD;&#x6570;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x4E3B;&#x51FD;&#x6570;main</span></div><div class="line">  <span class="keyword">auto</span> user_entrypoint_function =</div><div class="line">      Dart_GetField(Dart_RootLibrary(), tonic::ToDart(entrypoint_name.c_str()));</div><div class="line"></div><div class="line">  <span class="keyword">auto</span> entrypoint_args = tonic::ToDart(args);</div><div class="line">  <span class="comment">// [&#x89C1;2.4.8]</span></div><div class="line">  <span class="keyword">if</span> (!InvokeMainEntrypoint(user_entrypoint_function, entrypoint_args)) {</div><div class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">  }</div><div class="line"></div><div class="line">  phase_ = Phase::Running;</div><div class="line"></div><div class="line">  <span class="keyword">if</span> (on_run) {</div><div class="line">    on_run();</div><div class="line">  }</div><div class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">}</div></pre></td></tr></table></figure>
<h4 id="2-4-8-InvokeMainEntrypoint"><a href="#2-4-8-InvokeMainEntrypoint" class="headerlink" title="2.4.8 InvokeMainEntrypoint"></a>2.4.8 InvokeMainEntrypoint</h4><p><a href="https://github.com/flutter/engine/blob/flutter-1.17-candidate.5/runtime/dart_isolate.cc" target="_blank" rel="external">-&gt; flutter/runtime/dart_isolate.cc</a></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">[[nodiscard]] <span class="function"><span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">InvokeMainEntrypoint</span><span class="params">(</span></span></div><div class="line">    Dart_Handle user_entrypoint_function,</div><div class="line">    Dart_Handle args) {</div><div class="line">  <span class="keyword">if</span> (tonic::LogIfError(user_entrypoint_function)) {</div><div class="line">    FML_LOG(ERROR) &lt;&lt; <span class="string">&quot;Could not resolve main entrypoint function.&quot;</span>;</div><div class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">  }</div><div class="line">  <span class="comment">// [&#x89C1;2.4.9]</span></div><div class="line">  Dart_Handle start_main_isolate_function =</div><div class="line">      tonic::DartInvokeField(Dart_LookupLibrary(tonic::ToDart(<span class="string">&quot;dart:isolate&quot;</span>)),</div><div class="line">                             <span class="string">&quot;_getStartMainIsolateFunction&quot;</span>, {});</div><div class="line">  </div><div class="line">  <span class="keyword">if</span> (tonic::LogIfError(start_main_isolate_function)) {</div><div class="line">    FML_LOG(ERROR) &lt;&lt; <span class="string">&quot;Could not resolve main entrypoint trampoline.&quot;</span>;</div><div class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">  }</div><div class="line">  <span class="comment">// [&#x89C1;2.4.10]</span></div><div class="line">  <span class="keyword">if</span> (tonic::LogIfError(tonic::DartInvokeField(</div><div class="line">          Dart_LookupLibrary(tonic::ToDart(<span class="string">&quot;dart:ui&quot;</span>)), <span class="string">&quot;_runMainZoned&quot;</span>,</div><div class="line">          {start_main_isolate_function, user_entrypoint_function, args}))) {</div><div class="line">    FML_LOG(ERROR) &lt;&lt; <span class="string">&quot;Could not invoke the main entrypoint.&quot;</span>;</div><div class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">  }</div><div class="line"></div><div class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">}</div></pre></td></tr></table></figure>
<p>&#x7ECF;&#x8FC7;Dart&#x865A;&#x62DF;&#x673A;&#x6700;&#x7EC8;&#x4F1A;&#x8C03;&#x7528;&#x7684;Dart&#x5C42;&#x7684;_runMainZoned()&#x65B9;&#x6CD5;&#xFF0C;&#x5176;&#x4E2D;&#x53C2;&#x6570;start_main_isolate_function&#x7B49;&#x4E8E;_startIsolate&#x3002;</p>
<h4 id="2-4-9-getStartMainIsolateFunction"><a href="#2-4-9-getStartMainIsolateFunction" class="headerlink" title="2.4.9 _getStartMainIsolateFunction"></a>2.4.9 _getStartMainIsolateFunction</h4><p>&#x672A;&#x5B8C;&#x5F85;&#x7EED;</p>
<h4 id="2-4-10-runMainZoned"><a href="#2-4-10-runMainZoned" class="headerlink" title="2.4.10 _runMainZoned"></a>2.4.10 _runMainZoned</h4><p>&#x672A;&#x5B8C;&#x5F85;&#x7EED;</p>
<h3 id="3-FlutterEngine&#x521D;&#x59CB;&#x5316;"><a href="#3-FlutterEngine&#x521D;&#x59CB;&#x5316;" class="headerlink" title="3.FlutterEngine&#x521D;&#x59CB;&#x5316;"></a>3.FlutterEngine&#x521D;&#x59CB;&#x5316;</h3><h4 id="3-1-FlutterActivityAndFragmentDelegate-onAttach"><a href="#3-1-FlutterActivityAndFragmentDelegate-onAttach" class="headerlink" title="3.1 FlutterActivityAndFragmentDelegate#onAttach"></a>3.1 FlutterActivityAndFragmentDelegate#onAttach</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">onAttach</span><span class="params">(@NonNull Context context)</span> </span>{</div><div class="line">    ...</div><div class="line">    </div><div class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.flutterEngine == <span class="keyword">null</span>) {</div><div class="line">        <span class="keyword">this</span>.setupFlutterEngine();</div><div class="line">    }</div><div class="line"></div><div class="line">    ...</div><div class="line">}</div></pre></td></tr></table></figure>
<h4 id="3-2-FlutterActivityAndFragmentDelegate-setupFlutterEngine"><a href="#3-2-FlutterActivityAndFragmentDelegate-setupFlutterEngine" class="headerlink" title="3.2 FlutterActivityAndFragmentDelegate#setupFlutterEngine"></a>3.2 FlutterActivityAndFragmentDelegate#setupFlutterEngine</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">setupFlutterEngine</span><span class="params">()</span> </span>{</div><div class="line">    Log.v(<span class="string">&quot;FlutterActivityAndFragmentDelegate&quot;</span>, <span class="string">&quot;Setting up FlutterEngine.&quot;</span>);</div><div class="line">    String cachedEngineId = <span class="keyword">this</span>.host.getCachedEngineId();</div><div class="line">    <span class="comment">// &#x53D6;&#x7F13;&#x5B58;&#x7684;FlutterEngine</span></div><div class="line">    <span class="keyword">if</span> (cachedEngineId != <span class="keyword">null</span>) {</div><div class="line">        <span class="keyword">this</span>.flutterEngine = FlutterEngineCache.getInstance().get(cachedEngineId);</div><div class="line">        <span class="keyword">this</span>.isFlutterEngineFromHost = <span class="keyword">true</span>;</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.flutterEngine == <span class="keyword">null</span>) {</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;The requested cached FlutterEngine did not exist in the FlutterEngineCache: &apos;&quot;</span> + cachedEngineId + <span class="string">&quot;&apos;&quot;</span>);</div><div class="line">        }</div><div class="line">    } <span class="keyword">else</span> {</div><div class="line">        <span class="keyword">this</span>.flutterEngine = <span class="keyword">this</span>.host.provideFlutterEngine(<span class="keyword">this</span>.host.getContext());</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.flutterEngine != <span class="keyword">null</span>) {</div><div class="line">            <span class="keyword">this</span>.isFlutterEngineFromHost = <span class="keyword">true</span>;</div><div class="line">        } <span class="keyword">else</span> {</div><div class="line">            Log.v(<span class="string">&quot;FlutterActivityAndFragmentDelegate&quot;</span>, <span class="string">&quot;No preferred FlutterEngine was provided. Creating a new FlutterEngine for this FlutterFragment.&quot;</span>);</div><div class="line">            <span class="comment">// FlutterEngine&#x771F;&#x6B63;&#x7684;&#x521D;&#x59CB;&#x5316;[&#x89C1;3.3]</span></div><div class="line">            <span class="keyword">this</span>.flutterEngine = <span class="keyword">new</span> FlutterEngine(<span class="keyword">this</span>.host.getContext(), <span class="keyword">this</span>.host.getFlutterShellArgs().toArray(), <span class="keyword">false</span>);</div><div class="line">            <span class="keyword">this</span>.isFlutterEngineFromHost = <span class="keyword">false</span>;</div><div class="line">        }</div><div class="line">    }</div><div class="line">}</div></pre></td></tr></table></figure>
<h4 id="3-3-FlutterEngine&#x6784;&#x9020;&#x65B9;&#x6CD5;"><a href="#3-3-FlutterEngine&#x6784;&#x9020;&#x65B9;&#x6CD5;" class="headerlink" title="3.3 FlutterEngine&#x6784;&#x9020;&#x65B9;&#x6CD5;"></a>3.3 FlutterEngine&#x6784;&#x9020;&#x65B9;&#x6CD5;</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">FlutterEngine</span><span class="params">(@NonNull Context context, @Nullable String[] dartVmArgs, <span class="keyword">boolean</span> automaticallyRegisterPlugins)</span> </span>{</div><div class="line">    <span class="keyword">this</span>(context, FlutterLoader.getInstance(), <span class="keyword">new</span> FlutterJNI(), dartVmArgs, automaticallyRegisterPlugins);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">// &#x6700;&#x7EC8;&#x8C03;&#x7528;&#x5230;&#x6B64;&#x5904;</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">FlutterEngine</span><span class="params">(@NonNull Context context, @NonNull FlutterLoader flutterLoader, @NonNull FlutterJNI flutterJNI, @NonNull PlatformViewsController platformViewsController, @Nullable String[] dartVmArgs, <span class="keyword">boolean</span> automaticallyRegisterPlugins)</span> </span>{</div><div class="line">    <span class="keyword">this</span>.engineLifecycleListeners = <span class="keyword">new</span> HashSet();</div><div class="line">    <span class="keyword">this</span>.engineLifecycleListener = <span class="keyword">new</span> FlutterEngine.EngineLifecycleListener() {</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onPreEngineRestart</span><span class="params">()</span> </span>{</div><div class="line">            Log.v(<span class="string">&quot;FlutterEngine&quot;</span>, <span class="string">&quot;onPreEngineRestart()&quot;</span>);</div><div class="line">            Iterator var1 = FlutterEngine.<span class="keyword">this</span>.engineLifecycleListeners.iterator();</div><div class="line"></div><div class="line">            <span class="keyword">while</span>(var1.hasNext()) {</div><div class="line">                FlutterEngine.EngineLifecycleListener lifecycleListener = (FlutterEngine.EngineLifecycleListener)var1.next();</div><div class="line">                lifecycleListener.onPreEngineRestart();</div><div class="line">            }</div><div class="line"></div><div class="line">            FlutterEngine.<span class="keyword">this</span>.platformViewsController.onPreEngineRestart();</div><div class="line">        }</div><div class="line">    };</div><div class="line">    <span class="comment">//&#x4E0A;&#x9762;&#x6784;&#x9020;&#x65B9;&#x6CD5;new FlutterJNI()&#x4F20;&#x8FDB;&#x6765;&#x7684;&#xFF0C;nativeInit&#x65B9;&#x6CD5;&#x5C31;&#x5728;FlutterJNI&#x91CC;&#x9762;</span></div><div class="line">    <span class="keyword">this</span>.flutterJNI = flutterJNI;</div><div class="line">    <span class="comment">// &#x56DE;&#x5230;FlutterLoader#startInitialization&#x521D;&#x59CB;&#x5316;&#x65B9;&#x6CD5;&#xFF0C;&#x524D;&#x9762;&#x5728;&#x5206;&#x6790;&lt;FlutterApplication&#x542F;&#x52A8;&gt;&#x5DF2;&#x7ECF;&#x63D0;&#x5230;</span></div><div class="line">    flutterLoader.startInitialization(context.getApplicationContext());</div><div class="line">    <span class="comment">// &#x786E;&#x4FDD;&#x521D;&#x59CB;&#x5316;&#x5B8C;&#x6210;[&#x89C1;3.3.1]</span></div><div class="line">    flutterLoader.ensureInitializationComplete(context, dartVmArgs);</div><div class="line">    flutterJNI.addEngineLifecycleListener(<span class="keyword">this</span>.engineLifecycleListener);</div><div class="line">    <span class="comment">// [&#x89C1;3.3.2]</span></div><div class="line">    <span class="keyword">this</span>.attachToJni();</div><div class="line">    </div><div class="line">    ...</div><div class="line">    </div><div class="line">    <span class="keyword">if</span> (automaticallyRegisterPlugins) {</div><div class="line">        <span class="keyword">this</span>.registerPlugins();</div><div class="line">    }</div><div class="line">}</div></pre></td></tr></table></figure>
<h5 id="3-3-1-flutterLoader-ensureInitializationComplete-context-dartVmArgs"><a href="#3-3-1-flutterLoader-ensureInitializationComplete-context-dartVmArgs" class="headerlink" title="3.3.1 flutterLoader.ensureInitializationComplete(context, dartVmArgs)"></a>3.3.1 flutterLoader.ensureInitializationComplete(context, dartVmArgs)</h5><p>&#x8C03;&#x7528;FlutterJNI#nativeInit&#xFF0C;&#x6700;&#x7EC8;&#x8C03;&#x7528;C++&#x5BF9;&#x5E94;flutter_main.cc#FlutterMain::Init</p>
<h5 id="3-3-2-this-attachToJni"><a href="#3-3-2-this-attachToJni" class="headerlink" title="3.3.2 this.attachToJni()"></a>3.3.2 this.attachToJni()</h5><ol>
<li>&#x8C03;&#x7528;FlutterJNI#attachToNative-&gt;FlutterJNI#nativeAttach<br>(&#x5728;&#x52A0;&#x8F7D;flutter.so&#x65F6;&#x6CE8;&#x518C;&#x8BE5;&#x65B9;&#x6CD5;&#xFF0C;&#x89C1;<a href="https://github.com/flutter/engine/blob/flutter-1.17-candidate.5/shell/platform/android/platform_view_android_jni.cc" target="_blank" rel="external">flutter/shell/platform/android/platform_view_android_jni.cc</a>)</li>
<li>&#x8C03;&#x7528;C++&#x5BF9;&#x5E94;platform_view_android_jni.cc#AttachJNI&#xFF1A;&#x4E3A;&#x4E86;&#x5728;&#x5F15;&#x64CE;&#x5C42;&#x521D;&#x59CB;&#x5316;AndroidShellHolder&#x5BF9;&#x8C61;</li>
</ol>
<h4 id="3-4-AndroidShellHolder&#x521D;&#x59CB;&#x5316;"><a href="#3-4-AndroidShellHolder&#x521D;&#x59CB;&#x5316;" class="headerlink" title="3.4 AndroidShellHolder&#x521D;&#x59CB;&#x5316;"></a>3.4 AndroidShellHolder&#x521D;&#x59CB;&#x5316;</h4><p><a href="https://github.com/flutter/engine/blob/flutter-1.17-candidate.5/shell/platform/android/android_shell_holder.cc" target="_blank" rel="external">-&gt; flutter/shell/platform/android/android_shell_holder.cc</a></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div></pre></td><td class="code"><pre><div class="line">AndroidShellHolder::AndroidShellHolder(</div><div class="line">    flutter::Settings settings,</div><div class="line">    fml::jni::JavaObjectWeakGlobalRef java_object,</div><div class="line">    <span class="keyword">bool</span> is_background_view)</div><div class="line">    : settings_(<span class="built_in">std</span>::move(settings)), java_object_(java_object) {</div><div class="line">  <span class="keyword">static</span> <span class="keyword">size_t</span> shell_count = <span class="number">1</span>;</div><div class="line">  <span class="keyword">auto</span> thread_label = <span class="built_in">std</span>::to_string(shell_count++);</div><div class="line">  <span class="comment">// &#x521B;&#x5EFA;&#x7EBF;&#x7A0B;&#x79C1;&#x6709;&#x7684;key</span></div><div class="line">  FML_CHECK(pthread_key_create(&amp;thread_destruct_key_, ThreadDestructCallback) ==</div><div class="line">            <span class="number">0</span>);</div><div class="line"></div><div class="line">  <span class="keyword">if</span> (is_background_view) {</div><div class="line">    thread_host_ = {thread_label, ThreadHost::Type::UI};</div><div class="line">  } <span class="keyword">else</span> {</div><div class="line">    <span class="comment">// &#x521B;&#x5EFA;&#x76EE;&#x6807;&#x7EBF;&#x7A0B;[&#x89C1;3.5]</span></div><div class="line">    thread_host_ = {thread_label, ThreadHost::Type::UI | ThreadHost::Type::GPU | ThreadHost::Type::IO};</div><div class="line">  }</div><div class="line"></div><div class="line">  <span class="comment">// Detach from JNI when the UI and raster threads exit.</span></div><div class="line">  <span class="comment">// &#x5F53;UI&#x548C;GPU&#x7EBF;&#x7A0B;&#x9000;&#x51FA;&#x65F6;&#x4ECE;JNI&#x5206;&#x79BB;</span></div><div class="line">  <span class="function"><span class="keyword">auto</span> <span class="title">jni_exit_task</span><span class="params">([key = thread_destruct_key_]()</span> </span>{</div><div class="line">    FML_CHECK(pthread_setspecific(key, <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">void</span>*&gt;(<span class="number">1</span>)) == <span class="number">0</span>);</div><div class="line">  });</div><div class="line">  thread_host_.ui_thread-&gt;GetTaskRunner()-&gt;PostTask(jni_exit_task);</div><div class="line">  <span class="keyword">if</span> (!is_background_view) {</div><div class="line">    thread_host_.raster_thread-&gt;GetTaskRunner()-&gt;PostTask(jni_exit_task);</div><div class="line">  }</div><div class="line"></div><div class="line">  fml::WeakPtr&lt;PlatformViewAndroid&gt; weak_platform_view;</div><div class="line">  Shell::CreateCallback&lt;PlatformView&gt; on_create_platform_view =</div><div class="line">      [is_background_view, java_object, &amp;weak_platform_view](Shell&amp; shell) {</div><div class="line">        <span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;PlatformViewAndroid&gt; platform_view_android;</div><div class="line">        <span class="keyword">if</span> (is_background_view) {</div><div class="line">          platform_view_android = <span class="built_in">std</span>::make_unique&lt;PlatformViewAndroid&gt;(</div><div class="line">              shell,                   <span class="comment">// delegate</span></div><div class="line">              shell.GetTaskRunners(),  <span class="comment">// task runners</span></div><div class="line">              java_object              <span class="comment">// java object handle for JNI interop</span></div><div class="line">          );</div><div class="line"></div><div class="line">        } <span class="keyword">else</span> {</div><div class="line">          platform_view_android = <span class="built_in">std</span>::make_unique&lt;PlatformViewAndroid&gt;(</div><div class="line">              shell,                   <span class="comment">// delegate</span></div><div class="line">              shell.GetTaskRunners(),  <span class="comment">// task runners</span></div><div class="line">              java_object,             <span class="comment">// java object handle for JNI interop</span></div><div class="line">              shell.GetSettings()</div><div class="line">                  .enable_software_rendering  <span class="comment">// use software rendering</span></div><div class="line">          );</div><div class="line">        }</div><div class="line">        weak_platform_view = platform_view_android-&gt;GetWeakPtr();</div><div class="line">        <span class="keyword">return</span> platform_view_android;</div><div class="line">      };</div><div class="line"></div><div class="line">  Shell::CreateCallback&lt;Rasterizer&gt; on_create_rasterizer = [](Shell&amp; shell) {</div><div class="line">    <span class="keyword">return</span> <span class="built_in">std</span>::make_unique&lt;Rasterizer&gt;(shell, shell.GetTaskRunners());</div><div class="line">  };</div><div class="line"></div><div class="line">  <span class="comment">// The current thread will be used as the platform thread. Ensure that the message loop is initialized.</span></div><div class="line">  <span class="comment">// &#x628A;&#x5F53;&#x524D;&#x7EBF;&#x7A0B;&#x5C06;&#x7528;&#x4F5C;&#x5E73;&#x53F0;&#x7EBF;&#x7A0B;&#xFF0C;&#x5E76;&#x786E;&#x4FDD;&#x4E3A;&#x5F53;&#x524D;&#x7EBF;&#x7A0B;&#x521D;&#x59CB;&#x5316;MessageLoop</span></div><div class="line">  fml::MessageLoop::EnsureInitializedForCurrentThread();</div><div class="line">  fml::RefPtr&lt;fml::TaskRunner&gt; gpu_runner;</div><div class="line">  fml::RefPtr&lt;fml::TaskRunner&gt; ui_runner;</div><div class="line">  fml::RefPtr&lt;fml::TaskRunner&gt; io_runner;</div><div class="line">  fml::RefPtr&lt;fml::TaskRunner&gt; platform_runner =</div><div class="line">      fml::MessageLoop::GetCurrent().GetTaskRunner();</div><div class="line">  <span class="keyword">if</span> (is_background_view) {</div><div class="line">    <span class="keyword">auto</span> single_task_runner = thread_host_.ui_thread-&gt;GetTaskRunner();</div><div class="line">    gpu_runner = single_task_runner;</div><div class="line">    ui_runner = single_task_runner;</div><div class="line">    io_runner = single_task_runner;</div><div class="line">  } <span class="keyword">else</span> {</div><div class="line">    gpu_runner = thread_host_.raster_thread-&gt;GetTaskRunner();</div><div class="line">    ui_runner = thread_host_.ui_thread-&gt;GetTaskRunner();</div><div class="line">    io_runner = thread_host_.io_thread-&gt;GetTaskRunner();</div><div class="line">  }</div><div class="line">  <span class="comment">// &#x521B;&#x5EFA;Task Runners&#x5BF9;&#x8C61;</span></div><div class="line">  flutter::<span class="function">TaskRunners <span class="title">task_runners</span><span class="params">(thread_label,     <span class="comment">// label</span></span></span></div><div class="line">                                    platform_runner,  <span class="comment">// platform</span></div><div class="line">                                    gpu_runner,       <span class="comment">// raster</span></div><div class="line">                                    ui_runner,        <span class="comment">// ui</span></div><div class="line">                                    io_runner         <span class="comment">// io</span></div><div class="line">  );</div><div class="line">  <span class="comment">// &#x521B;&#x5EFA;Shell&#x5BF9;&#x8C61;[&#x89C1;3.6]</span></div><div class="line">  shell_ =</div><div class="line">      Shell::Create(task_runners,             <span class="comment">// task runners</span></div><div class="line">                    GetDefaultWindowData(),   <span class="comment">// window data</span></div><div class="line">                    settings_,                <span class="comment">// settings</span></div><div class="line">                    on_create_platform_view,  <span class="comment">// platform view create callback</span></div><div class="line">                    on_create_rasterizer      <span class="comment">// rasterizer create callback</span></div><div class="line">      );</div><div class="line"></div><div class="line">  platform_view_ = weak_platform_view;</div><div class="line">  FML_DCHECK(platform_view_);</div><div class="line"></div><div class="line">  is_valid_ = shell_ != <span class="literal">nullptr</span>;</div><div class="line"></div><div class="line">  <span class="keyword">if</span> (is_valid_) {</div><div class="line">    <span class="comment">// &#x63D0;&#x5347;ui&#x7EBF;&#x7A0B;&#x548C;gpu&#x7EBF;&#x7A0B;&#x7684;&#x4F18;&#x5148;&#x7EA7;</span></div><div class="line">    task_runners.GetRasterTaskRunner()-&gt;PostTask([]() {</div><div class="line">      <span class="comment">// Android describes -8 as &quot;most important display threads, for</span></div><div class="line">      <span class="comment">// compositing the screen and retrieving input events&quot;. Conservatively</span></div><div class="line">      <span class="comment">// set the raster thread to slightly lower priority than it.</span></div><div class="line">      <span class="keyword">if</span> (::setpriority(PRIO_PROCESS, gettid(), <span class="number">-5</span>) != <span class="number">0</span>) {</div><div class="line">        <span class="comment">// Defensive fallback. Depending on the OEM, it may not be possible</span></div><div class="line">        <span class="comment">// to set priority to -5.</span></div><div class="line">        <span class="keyword">if</span> (::setpriority(PRIO_PROCESS, gettid(), <span class="number">-2</span>) != <span class="number">0</span>) {</div><div class="line">          FML_LOG(ERROR) &lt;&lt; <span class="string">&quot;Failed to set GPU task runner priority&quot;</span>;</div><div class="line">        }</div><div class="line">      }</div><div class="line">    });</div><div class="line">    task_runners.GetUITaskRunner()-&gt;PostTask([]() {</div><div class="line">      <span class="keyword">if</span> (::setpriority(PRIO_PROCESS, gettid(), <span class="number">-1</span>) != <span class="number">0</span>) {</div><div class="line">        FML_LOG(ERROR) &lt;&lt; <span class="string">&quot;Failed to set UI task runner priority&quot;</span>;</div><div class="line">      }</div><div class="line">    });</div><div class="line">  }</div><div class="line">}</div></pre></td></tr></table></figure>
<p>&#x8BE5;&#x65B9;&#x6CD5;&#x4E3B;&#x8981;&#x529F;&#x80FD;&#xFF1A;</p>
<ol>
<li>&#x521B;&#x5EFA;UI/GPU/IO&#x4E09;&#x4E2A;&#x7EBF;&#x7A0B;&#xFF0C;&#x5E76;&#x4E3A;&#x5B83;&#x4EEC;&#x5206;&#x522B;&#x521D;&#x59CB;&#x5316;MessageLoop&#x3001;TaskRunner</li>
<li>&#x521B;&#x5EFA;TaskRunners&#x5BF9;&#x8C61; <a href="https://github.com/flutter/engine/blob/flutter-1.17-candidate.5/common/task_runners.cc" target="_blank" rel="external">-&gt;flutter/common/task_runners.cc</a></li>
<li>on_create_platform_view</li>
<li>on_create_rasterizer</li>
<li>&#x521B;&#x5EFA;Shell&#x5BF9;&#x8C61;</li>
</ol>
<h4 id="3-5-ThreadHost&#x521D;&#x59CB;&#x5316;"><a href="#3-5-ThreadHost&#x521D;&#x59CB;&#x5316;" class="headerlink" title="3.5 ThreadHost&#x521D;&#x59CB;&#x5316;"></a>3.5 ThreadHost&#x521D;&#x59CB;&#x5316;</h4><p><a href="https://github.com/flutter/engine/blob/flutter-1.17-candidate.5/shell/common/thread_host.cc" target="_blank" rel="external">-&gt; flutter/shell/common/thread_host.cc</a></p>
<ol>
<li>&#x6839;&#x636E;&#x4F20;&#x9012;&#x7684;&#x53C2;&#x6570;&#xFF0C;&#x9996;&#x6B21;&#x521B;&#x5EFA;AndroidShellHolder&#x5B9E;&#x4F8B;&#x7684;&#x8FC7;&#x7A0B;&#xFF0C;&#x4F1A;&#x521B;&#x5EFA;1.ui&#x3001;1.gpu&#x3001;1.io3&#x4E2A;&#x7EBF;&#x7A0B;</li>
<li>&#x6BCF;&#x4E2A;&#x7EBF;&#x7A0B;Thread&#x521D;&#x59CB;&#x5316;&#x8FC7;&#x7A0B; <a href="https://github.com/flutter/engine/blob/flutter-1.17-candidate.5/fml/thread.cc" target="_blank" rel="external">-&gt;flutter/fml/thread.cc</a>&#xFF0C;&#x90FD;&#x521B;&#x5EFA;&#x76F8;&#x5E94;&#x7684;MessageLoop <a href="https://github.com/flutter/engine/blob/flutter-1.17-candidate.5/fml/message_loop.cc" target="_blank" rel="external">-&gt;flutter/fml/message_loop.cc</a>&#x3001;TaskRunner<a href="https://github.com/flutter/engine/blob/flutter-1.17-candidate.5/fml/task_runner.cc" target="_blank" rel="external">-&gt;flutter/fml/task_runner.cc</a>&#x5BF9;&#x8C61;&#xFF0C;&#x7136;&#x540E;&#x8FDB;&#x5165;pollOnce&#x8F6E;&#x8BE2;&#x7B49;&#x5F85;&#x72B6;&#x6001;&#x3002;</li>
</ol>
<h4 id="3-6-&#x521B;&#x5EFA;Shell"><a href="#3-6-&#x521B;&#x5EFA;Shell" class="headerlink" title="3.6 &#x521B;&#x5EFA;Shell"></a>3.6 &#x521B;&#x5EFA;Shell</h4><p><a href="https://github.com/flutter/engine/blob/flutter-1.17-candidate.5/shell/common/shell.cc" target="_blank" rel="external">-&gt; flutter/shell/common/shell.cc</a></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;Shell&gt; Shell::Create(</div><div class="line">    TaskRunners task_runners,</div><div class="line">    <span class="keyword">const</span> WindowData window_data,</div><div class="line">    Settings settings,</div><div class="line">    Shell::CreateCallback&lt;PlatformView&gt; on_create_platform_view,</div><div class="line">    Shell::CreateCallback&lt;Rasterizer&gt; on_create_rasterizer) {</div><div class="line">  <span class="comment">// [&#x89C1;3.6.1]</span></div><div class="line">  PerformInitializationTasks(settings);</div><div class="line">  PersistentCache::SetCacheSkSL(settings.cache_sksl);</div><div class="line"></div><div class="line">  TRACE_EVENT0(<span class="string">&quot;flutter&quot;</span>, <span class="string">&quot;Shell::Create&quot;</span>);</div><div class="line">  <span class="comment">// [&#x89C1;3.6.2]</span></div><div class="line">  <span class="keyword">auto</span> vm = DartVMRef::Create(settings);</div><div class="line">  FML_CHECK(vm) &lt;&lt; <span class="string">&quot;Must be able to initialize the VM.&quot;</span>;</div><div class="line"></div><div class="line">  <span class="keyword">auto</span> vm_data = vm-&gt;GetVMData();</div><div class="line">  <span class="comment">// [&#x89C1;3.6.3]</span></div><div class="line">  <span class="keyword">return</span> Shell::Create(<span class="built_in">std</span>::move(task_runners),        <span class="comment">//</span></div><div class="line">                       <span class="built_in">std</span>::move(window_data),         <span class="comment">//</span></div><div class="line">                       <span class="built_in">std</span>::move(settings),            <span class="comment">//</span></div><div class="line">                       vm_data-&gt;GetIsolateSnapshot(),  <span class="comment">// isolate snapshot</span></div><div class="line">                       on_create_platform_view,        <span class="comment">//</span></div><div class="line">                       on_create_rasterizer,           <span class="comment">//</span></div><div class="line">                       <span class="built_in">std</span>::move(vm)                   <span class="comment">//</span></div><div class="line">  );</div><div class="line">}</div></pre></td></tr></table></figure>
<h5 id="3-6-1-PerformInitializationTasks"><a href="#3-6-1-PerformInitializationTasks" class="headerlink" title="3.6.1 PerformInitializationTasks()"></a>3.6.1 PerformInitializationTasks()</h5><p><a href="https://github.com/flutter/engine/blob/flutter-1.17-candidate.5/shell/common/shell.cc" target="_blank" rel="external">-&gt;flutter/shell/common/shell.cc</a></p>
<p>&#x9ED8;&#x8BA4;&#x60C5;&#x51B5;&#x53EA;&#x6709;ERROR&#x7EA7;&#x522B;&#x7684;&#x65E5;&#x5FD7;&#x624D;&#x4F1A;&#x8F93;&#x51FA;&#xFF0C;&#x9664;&#x975E;&#x5728;&#x542F;&#x52A8;&#x7684;&#x65F6;&#x5019;&#x5E26;&#x4E0A;&#x53C2;&#x6570;verbose_logging&#xFF0C;&#x5219;&#x4F1A;&#x6253;&#x5370;&#x51FA;INFO&#x7EA7;&#x522B;&#x7684;&#x65E5;&#x5FD7;&#x3002;</p>
<h5 id="3-6-2-DartVMRef-Create"><a href="#3-6-2-DartVMRef-Create" class="headerlink" title="3.6.2 DartVMRef::Create"></a>3.6.2 DartVMRef::Create</h5><p><a href="https://github.com/flutter/engine/blob/flutter-1.17-candidate.5/runtime/dart_vm_lifecycle.cc" target="_blank" rel="external">-&gt; flutter/runtime/dart_vm_lifecycle.cc</a></p>
<ol>
<li><p>&#x5F53;&#x8BE5;&#x8FDB;&#x7A0B;&#x5B58;&#x5728;&#x4E00;&#x4E2A;&#x6B63;&#x5728;&#x8FD0;&#x884C;&#x7684;&#x865A;&#x62DF;&#x673A;&#xFF0C;&#x83B7;&#x53D6;&#x5176;&#x5F3A;&#x5F15;&#x7528;&#xFF0C;&#x590D;&#x7528;&#x8BE5;&#x865A;&#x62DF;&#x673A;</p>
 <figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// If there is already a running VM in the process, grab a strong reference to</span></div><div class="line">  <span class="comment">// it.</span></div><div class="line">  <span class="keyword">if</span> (<span class="keyword">auto</span> vm = gVM.lock()) {</div><div class="line">    FML_DLOG(WARNING) &lt;&lt; <span class="string">&quot;Attempted to create a VM in a process where one was &quot;</span></div><div class="line">                         <span class="string">&quot;already running. Ignoring arguments for current VM &quot;</span></div><div class="line">                         <span class="string">&quot;create call and reusing the old VM.&quot;</span>;</div><div class="line">    <span class="comment">// There was already a running VM in the process,</span></div><div class="line">    <span class="keyword">return</span> DartVMRef{<span class="built_in">std</span>::move(vm)};</div><div class="line">  }</div></pre></td></tr></table></figure>
</li>
<li><p>&#x5982;&#x679C;&#x6CA1;&#x6709;&#x5219;&#x521B;&#x5EFA;&#x865A;&#x62DF;&#x673A;</p>
</li>
</ol>
<h5 id="3-6-3-Shell-Create"><a href="#3-6-3-Shell-Create" class="headerlink" title="3.6.3 Shell::Create"></a>3.6.3 Shell::Create</h5><p><a href="https://github.com/flutter/engine/blob/flutter-1.17-candidate.5/shell/common/shell.cc" target="_blank" rel="external">-&gt; flutter/shell/common/shell.cc</a></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;Shell&gt; Shell::Create(</div><div class="line">    TaskRunners task_runners,</div><div class="line">    <span class="keyword">const</span> WindowData window_data,</div><div class="line">    Settings settings,</div><div class="line">    fml::RefPtr&lt;<span class="keyword">const</span> DartSnapshot&gt; isolate_snapshot,</div><div class="line">    <span class="keyword">const</span> Shell::CreateCallback&lt;PlatformView&gt;&amp; on_create_platform_view,</div><div class="line">    <span class="keyword">const</span> Shell::CreateCallback&lt;Rasterizer&gt;&amp; on_create_rasterizer,</div><div class="line">    DartVMRef vm) {</div><div class="line">  PerformInitializationTasks(settings);</div><div class="line">  PersistentCache::SetCacheSkSL(settings.cache_sksl);</div><div class="line"></div><div class="line">  TRACE_EVENT0(<span class="string">&quot;flutter&quot;</span>, <span class="string">&quot;Shell::CreateWithSnapshots&quot;</span>);</div><div class="line"></div><div class="line">  <span class="keyword">if</span> (!task_runners.IsValid() || !on_create_platform_view ||</div><div class="line">      !on_create_rasterizer) {</div><div class="line">    <span class="keyword">return</span> <span class="literal">nullptr</span>;</div><div class="line">  }</div><div class="line"></div><div class="line">  fml::AutoResetWaitableEvent latch;</div><div class="line">  <span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;Shell&gt; shell;</div><div class="line">  fml::TaskRunner::RunNowOrPostTask(</div><div class="line">      task_runners.GetPlatformTaskRunner(),</div><div class="line">      fml::MakeCopyable([&amp;latch,                                          <span class="comment">//</span></div><div class="line">                         vm = <span class="built_in">std</span>::move(vm),                              <span class="comment">//</span></div><div class="line">                         &amp;shell,                                          <span class="comment">//</span></div><div class="line">                         task_runners = <span class="built_in">std</span>::move(task_runners),          <span class="comment">//</span></div><div class="line">                         window_data,                                     <span class="comment">//</span></div><div class="line">                         settings,                                        <span class="comment">//</span></div><div class="line">                         isolate_snapshot = <span class="built_in">std</span>::move(isolate_snapshot),  <span class="comment">//</span></div><div class="line">                         on_create_platform_view,                         <span class="comment">//</span></div><div class="line">                         on_create_rasterizer                             <span class="comment">//</span></div><div class="line">  ]() <span class="keyword">mutable</span> {</div><div class="line">        <span class="comment">// [&#x89C1;3.6.4]</span></div><div class="line">        shell = CreateShellOnPlatformThread(<span class="built_in">std</span>::move(vm),</div><div class="line">                                            <span class="built_in">std</span>::move(task_runners),      <span class="comment">//</span></div><div class="line">                                            window_data,                  <span class="comment">//</span></div><div class="line">                                            settings,                     <span class="comment">//</span></div><div class="line">                                            <span class="built_in">std</span>::move(isolate_snapshot),  <span class="comment">//</span></div><div class="line">                                            on_create_platform_view,      <span class="comment">//</span></div><div class="line">                                            on_create_rasterizer          <span class="comment">//</span></div><div class="line">        );</div><div class="line">        latch.Signal();</div><div class="line">      }));</div><div class="line">  latch.Wait();</div><div class="line">  <span class="keyword">return</span> shell;</div><div class="line">}</div></pre></td></tr></table></figure>
<h5 id="3-6-4-CreateShellOnPlatformThread"><a href="#3-6-4-CreateShellOnPlatformThread" class="headerlink" title="3.6.4 CreateShellOnPlatformThread"></a>3.6.4 CreateShellOnPlatformThread</h5><p><a href="https://github.com/flutter/engine/blob/flutter-1.17-candidate.5/shell/common/shell.cc" target="_blank" rel="external">-&gt; flutter/shell/common/shell.cc</a></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;Shell&gt; Shell::CreateShellOnPlatformThread(</div><div class="line">    DartVMRef vm,</div><div class="line">    TaskRunners task_runners,</div><div class="line">    <span class="keyword">const</span> WindowData window_data,</div><div class="line">    Settings settings,</div><div class="line">    fml::RefPtr&lt;<span class="keyword">const</span> DartSnapshot&gt; isolate_snapshot,</div><div class="line">    <span class="keyword">const</span> Shell::CreateCallback&lt;PlatformView&gt;&amp; on_create_platform_view,</div><div class="line">    <span class="keyword">const</span> Shell::CreateCallback&lt;Rasterizer&gt;&amp; on_create_rasterizer) {</div><div class="line">  <span class="keyword">if</span> (!task_runners.IsValid()) {</div><div class="line">    FML_LOG(ERROR) &lt;&lt; <span class="string">&quot;Task runners to run the shell were invalid.&quot;</span>;</div><div class="line">    <span class="keyword">return</span> <span class="literal">nullptr</span>;</div><div class="line">  }</div><div class="line"></div><div class="line">  <span class="comment">// &#x521B;&#x5EFA;Shell&#x5BF9;&#x8C61;[&#x89C1;3.6.5]</span></div><div class="line">  <span class="keyword">auto</span> shell =</div><div class="line">      <span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;Shell&gt;(<span class="keyword">new</span> Shell(<span class="built_in">std</span>::move(vm), task_runners, settings));</div><div class="line"></div><div class="line">  <span class="comment">// Create the rasterizer on the raster thread.</span></div><div class="line">  <span class="built_in">std</span>::promise&lt;<span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;Rasterizer&gt;&gt; rasterizer_promise;</div><div class="line">  <span class="keyword">auto</span> rasterizer_future = rasterizer_promise.get_future();</div><div class="line">  <span class="built_in">std</span>::promise&lt;fml::WeakPtr&lt;SnapshotDelegate&gt;&gt; snapshot_delegate_promise;</div><div class="line">  <span class="keyword">auto</span> snapshot_delegate_future = snapshot_delegate_promise.get_future();</div><div class="line">  fml::TaskRunner::RunNowOrPostTask(</div><div class="line">      task_runners.GetRasterTaskRunner(), [&amp;rasterizer_promise,  <span class="comment">//</span></div><div class="line">                                           &amp;snapshot_delegate_promise,</div><div class="line">                                           on_create_rasterizer,  <span class="comment">//</span></div><div class="line">                                           shell = shell.get()    <span class="comment">//</span></div><div class="line">  ]() {</div><div class="line">        TRACE_EVENT0(<span class="string">&quot;flutter&quot;</span>, <span class="string">&quot;ShellSetupGPUSubsystem&quot;</span>);</div><div class="line">        <span class="comment">// &#x5728;GPU&#x7EBF;&#x7A0B;&#x4E2D;&#x521B;&#x5EFA;rasterizer&#x5BF9;&#x8C61;[&#x89C1;3.6.6]</span></div><div class="line">        <span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;Rasterizer&gt; rasterizer(on_create_rasterizer(*shell));</div><div class="line">        snapshot_delegate_promise.set_value(rasterizer-&gt;GetSnapshotDelegate());</div><div class="line">        rasterizer_promise.set_value(<span class="built_in">std</span>::move(rasterizer));</div><div class="line">      });</div><div class="line"></div><div class="line">  <span class="comment">// Create the platform view on the platform thread (this thread).</span></div><div class="line">  <span class="comment">// &#x5728;&#x4E3B;&#x7EBF;&#x7A0B;&#x521B;&#x5EFA;platform_view[&#x89C1;3.6.7]</span></div><div class="line">  <span class="keyword">auto</span> platform_view = on_create_platform_view(*shell.get());</div><div class="line">  <span class="keyword">if</span> (!platform_view || !platform_view-&gt;GetWeakPtr()) {</div><div class="line">    <span class="keyword">return</span> <span class="literal">nullptr</span>;</div><div class="line">  }</div><div class="line"></div><div class="line">  <span class="comment">// Ask the platform view for the vsync waiter. This will be used by the engine</span></div><div class="line">  <span class="comment">// to create the animator.</span></div><div class="line">  <span class="comment">// &#x7531;platform_view&#x521B;&#x5EFA;vsync waiter [&#x89C1;3.6.8]</span></div><div class="line">  <span class="keyword">auto</span> vsync_waiter = platform_view-&gt;CreateVSyncWaiter();</div><div class="line">  <span class="keyword">if</span> (!vsync_waiter) {</div><div class="line">    <span class="keyword">return</span> <span class="literal">nullptr</span>;</div><div class="line">  }</div><div class="line"></div><div class="line">  <span class="comment">// Create the IO manager on the IO thread. The IO manager must be initialized</span></div><div class="line">  <span class="comment">// first because it has state that the other subsystems depend on. It must</span></div><div class="line">  <span class="comment">// first be booted and the necessary references obtained to initialize the</span></div><div class="line">  <span class="comment">// other subsystems.</span></div><div class="line">  <span class="built_in">std</span>::promise&lt;<span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;ShellIOManager&gt;&gt; io_manager_promise;</div><div class="line">  <span class="keyword">auto</span> io_manager_future = io_manager_promise.get_future();</div><div class="line">  <span class="built_in">std</span>::promise&lt;fml::WeakPtr&lt;ShellIOManager&gt;&gt; weak_io_manager_promise;</div><div class="line">  <span class="keyword">auto</span> weak_io_manager_future = weak_io_manager_promise.get_future();</div><div class="line">  <span class="built_in">std</span>::promise&lt;fml::RefPtr&lt;SkiaUnrefQueue&gt;&gt; unref_queue_promise;</div><div class="line">  <span class="keyword">auto</span> unref_queue_future = unref_queue_promise.get_future();</div><div class="line">  <span class="keyword">auto</span> io_task_runner = shell-&gt;GetTaskRunners().GetIOTaskRunner();</div><div class="line"></div><div class="line">  <span class="comment">// TODO(gw280): The WeakPtr here asserts that we are derefing it on the</span></div><div class="line">  <span class="comment">// same thread as it was created on. We are currently on the IO thread</span></div><div class="line">  <span class="comment">// inside this lambda but we need to deref the PlatformView, which was</span></div><div class="line">  <span class="comment">// constructed on the platform thread.</span></div><div class="line">  <span class="comment">//</span></div><div class="line">  <span class="comment">// https://github.com/flutter/flutter/issues/42948</span></div><div class="line">  fml::TaskRunner::RunNowOrPostTask(</div><div class="line">      io_task_runner,</div><div class="line">      [&amp;io_manager_promise,                                               <span class="comment">//</span></div><div class="line">       &amp;weak_io_manager_promise,                                          <span class="comment">//</span></div><div class="line">       &amp;unref_queue_promise,                                              <span class="comment">//</span></div><div class="line">       platform_view = platform_view-&gt;GetWeakPtr(),                       <span class="comment">//</span></div><div class="line">       io_task_runner,                                                    <span class="comment">//</span></div><div class="line">       is_backgrounded_sync_switch = shell-&gt;GetIsGpuDisabledSyncSwitch()  <span class="comment">//</span></div><div class="line">  ]() {</div><div class="line">        TRACE_EVENT0(<span class="string">&quot;flutter&quot;</span>, <span class="string">&quot;ShellSetupIOSubsystem&quot;</span>);</div><div class="line">        <span class="comment">// &#x5728;IO&#x7EBF;&#x7A0B;&#x4E2D;&#x521B;&#x5EFA;ShellIOManager&#x5BF9;&#x8C61;[&#x89C1;3.6.9]</span></div><div class="line">        <span class="keyword">auto</span> io_manager = <span class="built_in">std</span>::make_unique&lt;ShellIOManager&gt;(</div><div class="line">            platform_view.getUnsafe()-&gt;CreateResourceContext(),</div><div class="line">            is_backgrounded_sync_switch, io_task_runner);</div><div class="line">        weak_io_manager_promise.set_value(io_manager-&gt;GetWeakPtr());</div><div class="line">        unref_queue_promise.set_value(io_manager-&gt;GetSkiaUnrefQueue());</div><div class="line">        io_manager_promise.set_value(<span class="built_in">std</span>::move(io_manager));</div><div class="line">      });</div><div class="line"></div><div class="line">  <span class="comment">// Send dispatcher_maker to the engine constructor because shell won&apos;t have</span></div><div class="line">  <span class="comment">// platform_view set until Shell::Setup is called later.</span></div><div class="line">  <span class="keyword">auto</span> dispatcher_maker = platform_view-&gt;GetDispatcherMaker();</div><div class="line"></div><div class="line">  <span class="comment">// Create the engine on the UI thread.</span></div><div class="line">  <span class="built_in">std</span>::promise&lt;<span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;Engine&gt;&gt; engine_promise;</div><div class="line">  <span class="keyword">auto</span> engine_future = engine_promise.get_future();</div><div class="line">  fml::TaskRunner::RunNowOrPostTask(</div><div class="line">      shell-&gt;GetTaskRunners().GetUITaskRunner(),</div><div class="line">      fml::MakeCopyable([&amp;engine_promise,                                 <span class="comment">//</span></div><div class="line">                         shell = shell.get(),                             <span class="comment">//</span></div><div class="line">                         &amp;dispatcher_maker,                               <span class="comment">//</span></div><div class="line">                         &amp;window_data,                                    <span class="comment">//</span></div><div class="line">                         isolate_snapshot = <span class="built_in">std</span>::move(isolate_snapshot),  <span class="comment">//</span></div><div class="line">                         vsync_waiter = <span class="built_in">std</span>::move(vsync_waiter),          <span class="comment">//</span></div><div class="line">                         &amp;weak_io_manager_future,                         <span class="comment">//</span></div><div class="line">                         &amp;snapshot_delegate_future,                       <span class="comment">//</span></div><div class="line">                         &amp;unref_queue_future                              <span class="comment">//</span></div><div class="line">  ]() <span class="keyword">mutable</span> {</div><div class="line">        TRACE_EVENT0(<span class="string">&quot;flutter&quot;</span>, <span class="string">&quot;ShellSetupUISubsystem&quot;</span>);</div><div class="line">        <span class="keyword">const</span> <span class="keyword">auto</span>&amp; task_runners = shell-&gt;GetTaskRunners();</div><div class="line"></div><div class="line">        <span class="comment">// The animator is owned by the UI thread but it gets its vsync pulses</span></div><div class="line">        <span class="comment">// from the platform.</span></div><div class="line">        <span class="comment">// &#x521B;&#x5EFA;Animator&#x5BF9;&#x8C61; [&#x89C1;3.6.10]</span></div><div class="line">        <span class="keyword">auto</span> animator = <span class="built_in">std</span>::make_unique&lt;Animator&gt;(*shell, task_runners,</div><div class="line">                                                   <span class="built_in">std</span>::move(vsync_waiter));</div><div class="line">        <span class="comment">// &#x521B;&#x5EFA;Engine&#x5BF9;&#x8C61; [&#x89C1;3.6.11]</span></div><div class="line">        engine_promise.set_value(<span class="built_in">std</span>::make_unique&lt;Engine&gt;(</div><div class="line">            *shell,                         <span class="comment">//</span></div><div class="line">            dispatcher_maker,               <span class="comment">//</span></div><div class="line">            *shell-&gt;GetDartVM(),            <span class="comment">//</span></div><div class="line">            <span class="built_in">std</span>::move(isolate_snapshot),    <span class="comment">//</span></div><div class="line">            task_runners,                   <span class="comment">//</span></div><div class="line">            window_data,                    <span class="comment">//</span></div><div class="line">            shell-&gt;GetSettings(),           <span class="comment">//</span></div><div class="line">            <span class="built_in">std</span>::move(animator),            <span class="comment">//</span></div><div class="line">            weak_io_manager_future.get(),   <span class="comment">//</span></div><div class="line">            unref_queue_future.get(),       <span class="comment">//</span></div><div class="line">            snapshot_delegate_future.get()  <span class="comment">//</span></div><div class="line">            ));</div><div class="line">      }));</div><div class="line">  <span class="comment">// [&#x89C1;3.6.12]</span></div><div class="line">  <span class="keyword">if</span> (!shell-&gt;Setup(<span class="built_in">std</span>::move(platform_view),  <span class="comment">//</span></div><div class="line">                    engine_future.get(),       <span class="comment">//</span></div><div class="line">                    rasterizer_future.get(),   <span class="comment">//</span></div><div class="line">                    io_manager_future.get())   <span class="comment">//</span></div><div class="line">  ) {</div><div class="line">    <span class="keyword">return</span> <span class="literal">nullptr</span>;</div><div class="line">  }</div><div class="line"></div><div class="line">  <span class="keyword">return</span> shell;</div><div class="line">}</div></pre></td></tr></table></figure>
<h5 id="3-6-5-&#x521B;&#x5EFA;Shell&#x5BF9;&#x8C61;&#xFF1A;Shell-Shell"><a href="#3-6-5-&#x521B;&#x5EFA;Shell&#x5BF9;&#x8C61;&#xFF1A;Shell-Shell" class="headerlink" title="3.6.5 &#x521B;&#x5EFA;Shell&#x5BF9;&#x8C61;&#xFF1A;Shell::Shell()"></a>3.6.5 &#x521B;&#x5EFA;Shell&#x5BF9;&#x8C61;&#xFF1A;Shell::Shell()</h5><p><a href="https://github.com/flutter/engine/blob/flutter-1.17-candidate.5/shell/common/shell.cc" target="_blank" rel="external">-&gt; flutter/shell/common/shell.cc</a></p>
<p>&#x521B;&#x5EFA;Shell&#x5BF9;&#x8C61;&#xFF0C;&#x6210;&#x5458;&#x53D8;&#x91CF;task<em>runners</em>&#x3001;settings<em>&#x4EE5;&#x53CA;vm</em>&#x8D4B;&#x521D;&#x503C;</p>
<h5 id="3-6-6-&#x521B;&#x5EFA;rasterizer&#x5BF9;&#x8C61;"><a href="#3-6-6-&#x521B;&#x5EFA;rasterizer&#x5BF9;&#x8C61;" class="headerlink" title="3.6.6 &#x521B;&#x5EFA;rasterizer&#x5BF9;&#x8C61;"></a>3.6.6 &#x521B;&#x5EFA;rasterizer&#x5BF9;&#x8C61;</h5><p><a href="https://github.com/flutter/engine/blob/flutter-1.17-candidate.5/shell/common/rasterizer.cc" target="_blank" rel="external">-&gt; flutter/shell/common/rasterizer.cc</a></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">Rasterizer::Rasterizer(Delegate&amp; delegate, TaskRunners task_runners)</div><div class="line">    : Rasterizer(delegate,</div><div class="line">                 <span class="built_in">std</span>::move(task_runners),</div><div class="line">                 <span class="built_in">std</span>::make_unique&lt;flutter::CompositorContext&gt;(</div><div class="line">                     delegate.GetFrameBudget())) {}</div><div class="line"></div><div class="line">Rasterizer::Rasterizer(</div><div class="line">    Delegate&amp; delegate,</div><div class="line">    TaskRunners task_runners,</div><div class="line">    <span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;flutter::CompositorContext&gt; compositor_context)</div><div class="line">    : delegate_(delegate),</div><div class="line">      task_runners_(<span class="built_in">std</span>::move(task_runners)),</div><div class="line">      compositor_context_(<span class="built_in">std</span>::move(compositor_context)),</div><div class="line">      user_override_resource_cache_bytes_(<span class="literal">false</span>),</div><div class="line">      weak_factory_(<span class="keyword">this</span>) {</div><div class="line">  FML_DCHECK(compositor_context_);</div><div class="line">}</div></pre></td></tr></table></figure>
<p>on_create_rasterizer&#x65B9;&#x6CD5;&#x7B49;&#x4EF7;&#x4E8E;&#x521B;&#x5EFA;Rasterizer&#x5BF9;&#x8C61;&#xFF0C;&#x5728;&#x8FD9;&#x4E2A;&#x8FC7;&#x7A0B;&#x8FD8;&#x4F1A;&#x521B;&#x5EFA;CompositorContext&#x5BF9;&#x8C61;&#x5E76;&#x8D4B;&#x503C;&#x7ED9;compositor<em>context</em>&#x3002;</p>
<h5 id="3-6-7-&#x521B;&#x5EFA;platform-view&#xFF1A;on-create-platform-view"><a href="#3-6-7-&#x521B;&#x5EFA;platform-view&#xFF1A;on-create-platform-view" class="headerlink" title="3.6.7 &#x521B;&#x5EFA;platform_view&#xFF1A;on_create_platform_view"></a>3.6.7 &#x521B;&#x5EFA;platform_view&#xFF1A;on_create_platform_view</h5><p><a href="https://github.com/flutter/engine/blob/flutter-1.17-candidate.5/shell/platform/android/platform_view_android.cc" target="_blank" rel="external">-&gt; flutter/shell/platform/android/platform_view_android.cc</a></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">PlatformViewAndroid::PlatformViewAndroid(</div><div class="line">    PlatformView::Delegate&amp; delegate,</div><div class="line">    flutter::TaskRunners task_runners,</div><div class="line">    fml::jni::JavaObjectWeakGlobalRef java_object,</div><div class="line">    <span class="keyword">bool</span> use_software_rendering)</div><div class="line">    : PlatformView(delegate, <span class="built_in">std</span>::move(task_runners)),</div><div class="line">      java_object_(java_object),</div><div class="line">      android_surface_(AndroidSurface::Create(use_software_rendering)) {</div><div class="line">  FML_CHECK(android_surface_)</div><div class="line">      &lt;&lt; <span class="string">&quot;Could not create an OpenGL, Vulkan or Software surface to setup &quot;</span></div><div class="line">         <span class="string">&quot;rendering.&quot;</span>;</div><div class="line">}</div></pre></td></tr></table></figure>
<p>on_create_platform_view&#x65B9;&#x6CD5;&#x7684;&#x6838;&#x5FC3;&#x5C31;&#x662F;&#x521B;&#x5EFA;PlatformViewAndroid&#x5BF9;&#x8C61;&#x3002;</p>
<p><a href="https://github.com/flutter/engine/blob/flutter-1.17-candidate.5/shell/platform/android/android_surface.cc" target="_blank" rel="external">-&gt; flutter/shell/platform/android/android_surface.cc</a></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;AndroidSurface&gt; AndroidSurface::Create(</div><div class="line">    <span class="keyword">bool</span> use_software_rendering) {</div><div class="line">  <span class="keyword">if</span> (use_software_rendering) {</div><div class="line">    <span class="keyword">auto</span> software_surface = <span class="built_in">std</span>::make_unique&lt;AndroidSurfaceSoftware&gt;();</div><div class="line">    <span class="keyword">return</span> software_surface-&gt;IsValid() ? <span class="built_in">std</span>::move(software_surface) : <span class="literal">nullptr</span>;</div><div class="line">  }</div><div class="line"><span class="meta">#<span class="meta-keyword">if</span> SHELL_ENABLE_VULKAN</span></div><div class="line">  <span class="keyword">auto</span> vulkan_surface = <span class="built_in">std</span>::make_unique&lt;AndroidSurfaceVulkan&gt;();</div><div class="line">  <span class="keyword">return</span> vulkan_surface-&gt;IsValid() ? <span class="built_in">std</span>::move(vulkan_surface) : <span class="literal">nullptr</span>;</div><div class="line"><span class="meta">#<span class="meta-keyword">else</span>   <span class="comment">// SHELL_ENABLE_VULKAN</span></span></div><div class="line">  <span class="keyword">auto</span> gl_surface = <span class="built_in">std</span>::make_unique&lt;AndroidSurfaceGL&gt;();</div><div class="line">  <span class="keyword">return</span> gl_surface-&gt;IsOffscreenContextValid() ? <span class="built_in">std</span>::move(gl_surface)</div><div class="line">                                               : <span class="literal">nullptr</span>;</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span>  <span class="comment">// SHELL_ENABLE_VULKAN</span></span></div><div class="line">}</div></pre></td></tr></table></figure>
<p>&#x6709;&#x4E09;&#x79CD;&#x4E0D;&#x540C;&#x7684;AndroidSurface&#x3002;</p>
<h5 id="3-6-8-&#x521B;&#x5EFA;vsync-waiter&#xFF1A;platform-view-gt-CreateVSyncWaiter"><a href="#3-6-8-&#x521B;&#x5EFA;vsync-waiter&#xFF1A;platform-view-gt-CreateVSyncWaiter" class="headerlink" title="3.6.8 &#x521B;&#x5EFA;vsync waiter&#xFF1A;platform_view-&gt;CreateVSyncWaiter"></a>3.6.8 &#x521B;&#x5EFA;vsync waiter&#xFF1A;platform_view-&gt;CreateVSyncWaiter</h5><p><a href="https://github.com/flutter/engine/blob/flutter-1.17-candidate.5/shell/platform/android/platform_view_android.cc" target="_blank" rel="external">-&gt; flutter/shell/platform/android/platform_view_android.cc</a></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;VsyncWaiter&gt; PlatformViewAndroid::CreateVSyncWaiter() {</div><div class="line">  <span class="keyword">return</span> <span class="built_in">std</span>::make_unique&lt;VsyncWaiterAndroid&gt;(task_runners_);</div><div class="line">}</div></pre></td></tr></table></figure>
<p><a href="https://github.com/flutter/engine/blob/flutter-1.17-candidate.5/shell/platform/android/vsync_waiter_android.cc" target="_blank" rel="external">-&gt; flutter/shell/platform/android/vsync_waiter_android.cc</a></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">VsyncWaiterAndroid::VsyncWaiterAndroid(flutter::TaskRunners task_runners)</div><div class="line">    : VsyncWaiter(<span class="built_in">std</span>::move(task_runners)) {}</div></pre></td></tr></table></figure>
<p>&#x521B;&#x5EFA;VsyncWaiterAndroid&#x5BF9;&#x8C61;&#xFF0C;&#x4E5F;&#x4F1A;&#x521D;&#x59CB;&#x5316;&#x7236;&#x7C7B;VsyncWaiter&#x3002;</p>
<h5 id="3-6-9-&#x521B;&#x5EFA;ShellIOManager"><a href="#3-6-9-&#x521B;&#x5EFA;ShellIOManager" class="headerlink" title="3.6.9 &#x521B;&#x5EFA;ShellIOManager"></a>3.6.9 &#x521B;&#x5EFA;ShellIOManager</h5><p><a href="https://github.com/flutter/engine/blob/flutter-1.17-candidate.5/shell/common/shell_io_manager.cc" target="_blank" rel="external">-&gt; flutter/shell/common/shell_io_manager.cc</a></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">ShellIOManager::ShellIOManager(</div><div class="line">    sk_sp&lt;GrContext&gt; resource_context,</div><div class="line">    <span class="built_in">std</span>::<span class="built_in">shared_ptr</span>&lt;fml::SyncSwitch&gt; is_gpu_disabled_sync_switch,</div><div class="line">    fml::RefPtr&lt;fml::TaskRunner&gt; unref_queue_task_runner)</div><div class="line">    : resource_context_(<span class="built_in">std</span>::move(resource_context)),</div><div class="line">      resource_context_weak_factory_(</div><div class="line">          resource_context_ ? <span class="built_in">std</span>::make_unique&lt;fml::WeakPtrFactory&lt;GrContext&gt;&gt;(</div><div class="line">                                  resource_context_.get())</div><div class="line">                            : <span class="literal">nullptr</span>),</div><div class="line">      unref_queue_(fml::MakeRefCounted&lt;flutter::SkiaUnrefQueue&gt;(</div><div class="line">          <span class="built_in">std</span>::move(unref_queue_task_runner),</div><div class="line">          fml::TimeDelta::FromMilliseconds(<span class="number">8</span>),</div><div class="line">          GetResourceContext())),</div><div class="line">      weak_factory_(<span class="keyword">this</span>),</div><div class="line">      is_gpu_disabled_sync_switch_(is_gpu_disabled_sync_switch) {</div><div class="line">  <span class="keyword">if</span> (!resource_context_) {</div><div class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> OS_FUCHSIA</span></div><div class="line">    FML_DLOG(WARNING) &lt;&lt; <span class="string">&quot;The IO manager was initialized without a resource &quot;</span></div><div class="line">                         <span class="string">&quot;context. Async texture uploads will be disabled. &quot;</span></div><div class="line">                         <span class="string">&quot;Expect performance degradation.&quot;</span>;</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span>  <span class="comment">// OS_FUCHSIA</span></span></div><div class="line">  }</div><div class="line">}</div></pre></td></tr></table></figure>
<p>ShellIOManager&#x7684;&#x521D;&#x59CB;&#x5316;&#x8FC7;&#x7A0B;&#xFF0C;&#x4F1A;&#x521B;&#x5EFA;GrContext&#x548C;SkiaUnrefQueue&#x5BF9;&#x8C61;&#x3002;</p>
<h5 id="3-6-10-&#x521B;&#x5EFA;Animator"><a href="#3-6-10-&#x521B;&#x5EFA;Animator" class="headerlink" title="3.6.10 &#x521B;&#x5EFA;Animator"></a>3.6.10 &#x521B;&#x5EFA;Animator</h5><p><a href="https://github.com/flutter/engine/blob/flutter-1.17-candidate.5/shell/common/animator.cc" target="_blank" rel="external">-&gt; flutter/shell/common/animator.cc</a></p>
<h5 id="3-6-11-&#x521B;&#x5EFA;Engine"><a href="#3-6-11-&#x521B;&#x5EFA;Engine" class="headerlink" title="3.6.11 &#x521B;&#x5EFA;Engine"></a>3.6.11 &#x521B;&#x5EFA;Engine</h5><p><a href="https://github.com/flutter/engine/blob/flutter-1.17-candidate.5/shell/common/engine.cc" target="_blank" rel="external">-&gt; flutter/shell/common/engine.cc</a></p>
<p>&#x521B;&#x5EFA;RuntimeController&#x5BF9;&#x8C61;&#x3002;</p>
<p><a href="https://github.com/flutter/engine/blob/flutter-1.17-candidate.5/runtime/runtime_controller.cc" target="_blank" rel="external">-&gt; flutter/runtime/runtime_controller.cc</a></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div></pre></td><td class="code"><pre><div class="line">RuntimeController::RuntimeController(</div><div class="line">    RuntimeDelegate&amp; p_client,</div><div class="line">    DartVM* p_vm,</div><div class="line">    fml::RefPtr&lt;<span class="keyword">const</span> DartSnapshot&gt; p_isolate_snapshot,</div><div class="line">    TaskRunners p_task_runners,</div><div class="line">    fml::WeakPtr&lt;SnapshotDelegate&gt; p_snapshot_delegate,</div><div class="line">    fml::WeakPtr&lt;IOManager&gt; p_io_manager,</div><div class="line">    fml::RefPtr&lt;SkiaUnrefQueue&gt; p_unref_queue,</div><div class="line">    fml::WeakPtr&lt;ImageDecoder&gt; p_image_decoder,</div><div class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> p_advisory_script_uri,</div><div class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> p_advisory_script_entrypoint,</div><div class="line">    <span class="keyword">const</span> <span class="built_in">std</span>::function&lt;<span class="keyword">void</span>(<span class="keyword">int64_t</span>)&gt;&amp; idle_notification_callback,</div><div class="line">    <span class="keyword">const</span> WindowData&amp; p_window_data,</div><div class="line">    <span class="keyword">const</span> fml::closure&amp; p_isolate_create_callback,</div><div class="line">    <span class="keyword">const</span> fml::closure&amp; p_isolate_shutdown_callback,</div><div class="line">    <span class="built_in">std</span>::<span class="built_in">shared_ptr</span>&lt;<span class="keyword">const</span> fml::Mapping&gt; p_persistent_isolate_data)</div><div class="line">    : client_(p_client),</div><div class="line">      vm_(p_vm),</div><div class="line">      isolate_snapshot_(<span class="built_in">std</span>::move(p_isolate_snapshot)),</div><div class="line">      task_runners_(p_task_runners),</div><div class="line">      snapshot_delegate_(p_snapshot_delegate),</div><div class="line">      io_manager_(p_io_manager),</div><div class="line">      unref_queue_(p_unref_queue),</div><div class="line">      image_decoder_(p_image_decoder),</div><div class="line">      advisory_script_uri_(p_advisory_script_uri),</div><div class="line">      advisory_script_entrypoint_(p_advisory_script_entrypoint),</div><div class="line">      idle_notification_callback_(idle_notification_callback),</div><div class="line">      window_data_(<span class="built_in">std</span>::move(p_window_data)),</div><div class="line">      isolate_create_callback_(p_isolate_create_callback),</div><div class="line">      isolate_shutdown_callback_(p_isolate_shutdown_callback),</div><div class="line">      persistent_isolate_data_(<span class="built_in">std</span>::move(p_persistent_isolate_data)) {</div><div class="line">  <span class="comment">// Create the root isolate as soon as the runtime controller is initialized.</span></div><div class="line">  <span class="comment">// It will be run at a later point when the engine provides a run</span></div><div class="line">  <span class="comment">// configuration and then runs the isolate.</span></div><div class="line">  <span class="keyword">auto</span> strong_root_isolate =</div><div class="line">      <span class="comment">// &#x521B;&#x5EFA;RootIsolate[&#x89C1;3.6.11.2]</span></div><div class="line">      DartIsolate::CreateRootIsolate(vm_-&gt;GetVMData()-&gt;GetSettings(),  <span class="comment">//</span></div><div class="line">                                     isolate_snapshot_,                <span class="comment">//</span></div><div class="line">                                     task_runners_,                    <span class="comment">//</span></div><div class="line">                                     <span class="comment">// &#x521B;&#x5EFA;Window&#x5BF9;&#x8C61;[3.6.11.1]  </span></div><div class="line">                                     <span class="built_in">std</span>::make_unique&lt;Window&gt;(<span class="keyword">this</span>),            <span class="comment">//</span></div><div class="line">                                     snapshot_delegate_,               <span class="comment">//</span></div><div class="line">                                     io_manager_,                      <span class="comment">//</span></div><div class="line">                                     unref_queue_,                     <span class="comment">//</span></div><div class="line">                                     image_decoder_,                   <span class="comment">//</span></div><div class="line">                                     p_advisory_script_uri,            <span class="comment">//</span></div><div class="line">                                     p_advisory_script_entrypoint,     <span class="comment">//</span></div><div class="line">                                     <span class="literal">nullptr</span>,                          <span class="comment">//</span></div><div class="line">                                     isolate_create_callback_,         <span class="comment">//</span></div><div class="line">                                     isolate_shutdown_callback_        <span class="comment">//</span></div><div class="line">                                     )</div><div class="line">          .lock();</div><div class="line"></div><div class="line">  FML_CHECK(strong_root_isolate) &lt;&lt; <span class="string">&quot;Could not create root isolate.&quot;</span>;</div><div class="line"></div><div class="line">  <span class="comment">// The root isolate ivar is weak.</span></div><div class="line">  root_isolate_ = strong_root_isolate;</div><div class="line"></div><div class="line">  strong_root_isolate-&gt;SetReturnCodeCallback([<span class="keyword">this</span>](<span class="keyword">uint32_t</span> code) {</div><div class="line">    root_isolate_return_code_ = {<span class="literal">true</span>, code};</div><div class="line">  });</div><div class="line"></div><div class="line">  <span class="keyword">if</span> (<span class="keyword">auto</span>* window = GetWindowIfAvailable()) {</div><div class="line">    tonic::DartState::<span class="function">Scope <span class="title">scope</span><span class="params">(strong_root_isolate)</span></span>;</div><div class="line">    window-&gt;DidCreateIsolate();</div><div class="line">    <span class="keyword">if</span> (!FlushRuntimeStateToIsolate()) {</div><div class="line">      FML_DLOG(ERROR) &lt;&lt; <span class="string">&quot;Could not setup initial isolate state.&quot;</span>;</div><div class="line">    }</div><div class="line">  } <span class="keyword">else</span> {</div><div class="line">    FML_DCHECK(<span class="literal">false</span>) &lt;&lt; <span class="string">&quot;RuntimeController created without window binding.&quot;</span>;</div><div class="line">  }</div><div class="line"></div><div class="line">  FML_DCHECK(Dart_CurrentIsolate() == <span class="literal">nullptr</span>);</div><div class="line">}</div></pre></td></tr></table></figure>
<h6 id="3-6-11-1-&#x521B;&#x5EFA;Window&#xFF1A;-gt-flutter-lib-ui-window-window-cc"><a href="#3-6-11-1-&#x521B;&#x5EFA;Window&#xFF1A;-gt-flutter-lib-ui-window-window-cc" class="headerlink" title="3.6.11.1 &#x521B;&#x5EFA;Window&#xFF1A;-&gt; flutter/lib/ui/window/window.cc"></a>3.6.11.1 &#x521B;&#x5EFA;Window&#xFF1A;<a href="https://github.com/flutter/engine/blob/flutter-1.17-candidate.5/lib/ui/window/window.cc" target="_blank" rel="external">-&gt; flutter/lib/ui/window/window.cc</a></h6><h6 id="3-6-11-2-&#x521B;&#x5EFA;RootIsolate&#xFF1A;DartIsolate-CreateRootIsolate"><a href="#3-6-11-2-&#x521B;&#x5EFA;RootIsolate&#xFF1A;DartIsolate-CreateRootIsolate" class="headerlink" title="3.6.11.2 &#x521B;&#x5EFA;RootIsolate&#xFF1A;DartIsolate::CreateRootIsolate"></a>3.6.11.2 &#x521B;&#x5EFA;RootIsolate&#xFF1A;DartIsolate::CreateRootIsolate</h6><p><a href="https://github.com/flutter/engine/blob/flutter-1.17-candidate.5/runtime/dart_isolate.cc" target="_blank" rel="external">-&gt; flutter/runtime/dart_isolate.cc</a></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">std</span>::weak_ptr&lt;DartIsolate&gt; DartIsolate::CreateRootIsolate(</div><div class="line">    <span class="keyword">const</span> Settings&amp; settings,</div><div class="line">    fml::RefPtr&lt;<span class="keyword">const</span> DartSnapshot&gt; isolate_snapshot,</div><div class="line">    TaskRunners task_runners,</div><div class="line">    <span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;Window&gt; window,</div><div class="line">    fml::WeakPtr&lt;SnapshotDelegate&gt; snapshot_delegate,</div><div class="line">    fml::WeakPtr&lt;IOManager&gt; io_manager,</div><div class="line">    fml::RefPtr&lt;SkiaUnrefQueue&gt; unref_queue,</div><div class="line">    fml::WeakPtr&lt;ImageDecoder&gt; image_decoder,</div><div class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> advisory_script_uri,</div><div class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> advisory_script_entrypoint,</div><div class="line">    Dart_IsolateFlags* flags,</div><div class="line">    <span class="keyword">const</span> fml::closure&amp; isolate_create_callback,</div><div class="line">    <span class="keyword">const</span> fml::closure&amp; isolate_shutdown_callback) {</div><div class="line">  TRACE_EVENT0(<span class="string">&quot;flutter&quot;</span>, <span class="string">&quot;DartIsolate::CreateRootIsolate&quot;</span>);</div><div class="line"></div><div class="line">  <span class="comment">// The child isolate preparer is null but will be set when the isolate is</span></div><div class="line">  <span class="comment">// being prepared to run.</span></div><div class="line">  <span class="keyword">auto</span> isolate_group_data =</div><div class="line">      <span class="built_in">std</span>::make_unique&lt;<span class="built_in">std</span>::<span class="built_in">shared_ptr</span>&lt;DartIsolateGroupData&gt;&gt;(</div><div class="line">          <span class="built_in">std</span>::<span class="built_in">shared_ptr</span>&lt;DartIsolateGroupData&gt;(<span class="keyword">new</span> DartIsolateGroupData(</div><div class="line">              settings,                     <span class="comment">// settings</span></div><div class="line">              <span class="built_in">std</span>::move(isolate_snapshot),  <span class="comment">// isolate snapshot</span></div><div class="line">              advisory_script_uri,          <span class="comment">// advisory URI</span></div><div class="line">              advisory_script_entrypoint,   <span class="comment">// advisory entrypoint</span></div><div class="line">              <span class="literal">nullptr</span>,                      <span class="comment">// child isolate preparer</span></div><div class="line">              isolate_create_callback,      <span class="comment">// isolate create callback</span></div><div class="line">              isolate_shutdown_callback     <span class="comment">// isolate shutdown callback</span></div><div class="line">              )));</div><div class="line">  <span class="comment">// &#x521B;&#x5EFA;DartIsolate    </span></div><div class="line">  <span class="keyword">auto</span> isolate_data = <span class="built_in">std</span>::make_unique&lt;<span class="built_in">std</span>::<span class="built_in">shared_ptr</span>&lt;DartIsolate&gt;&gt;(</div><div class="line">      <span class="built_in">std</span>::<span class="built_in">shared_ptr</span>&lt;DartIsolate&gt;(<span class="keyword">new</span> DartIsolate(</div><div class="line">          settings,                      <span class="comment">// settings</span></div><div class="line">          task_runners,                  <span class="comment">// task runners</span></div><div class="line">          <span class="built_in">std</span>::move(snapshot_delegate),  <span class="comment">// snapshot delegate</span></div><div class="line">          <span class="built_in">std</span>::move(io_manager),         <span class="comment">// IO manager</span></div><div class="line">          <span class="built_in">std</span>::move(unref_queue),        <span class="comment">// Skia unref queue</span></div><div class="line">          <span class="built_in">std</span>::move(image_decoder),      <span class="comment">// Image Decoder</span></div><div class="line">          advisory_script_uri,           <span class="comment">// advisory URI</span></div><div class="line">          advisory_script_entrypoint,    <span class="comment">// advisory entrypoint</span></div><div class="line">          <span class="literal">true</span>                           <span class="comment">// is_root_isolate</span></div><div class="line">          )));</div><div class="line"></div><div class="line">  DartErrorString error;</div><div class="line">  Dart_Isolate vm_isolate =</div><div class="line">      CreateDartIsolateGroup(<span class="built_in">std</span>::move(isolate_group_data),</div><div class="line">                             <span class="built_in">std</span>::move(isolate_data), flags, error.error());</div><div class="line"></div><div class="line">  <span class="keyword">if</span> (error) {</div><div class="line">    FML_LOG(ERROR) &lt;&lt; <span class="string">&quot;CreateDartIsolateGroup failed: &quot;</span> &lt;&lt; error.str();</div><div class="line">  }</div><div class="line"></div><div class="line">  <span class="keyword">if</span> (vm_isolate == <span class="literal">nullptr</span>) {</div><div class="line">    <span class="keyword">return</span> {};</div><div class="line">  }</div><div class="line"></div><div class="line">  <span class="built_in">std</span>::<span class="built_in">shared_ptr</span>&lt;DartIsolate&gt;* root_isolate_data =</div><div class="line">      <span class="keyword">static_cast</span>&lt;<span class="built_in">std</span>::<span class="built_in">shared_ptr</span>&lt;DartIsolate&gt;*&gt;(Dart_IsolateData(vm_isolate));</div><div class="line">  <span class="comment">// &#x53EA;&#x6709;root_isolate_data&#x80FD;&#x548C;window&#x4EA4;&#x4E92;</span></div><div class="line">  (*root_isolate_data)-&gt;SetWindow(<span class="built_in">std</span>::move(window));</div><div class="line"></div><div class="line">  <span class="keyword">return</span> (*root_isolate_data)-&gt;GetWeakIsolatePtr();</div><div class="line">}</div></pre></td></tr></table></figure>
<h5 id="3-6-12-shell-gt-Setup"><a href="#3-6-12-shell-gt-Setup" class="headerlink" title="3.6.12 shell-&gt;Setup"></a>3.6.12 shell-&gt;Setup</h5><p><a href="https://github.com/flutter/engine/blob/flutter-1.17-candidate.5/shell/common/shell.cc" target="_blank" rel="external">-&gt; flutter/shell/common/shell.cc</a></p>
<h3 id="&#x53C2;&#x8003;"><a href="#&#x53C2;&#x8003;" class="headerlink" title="&#x53C2;&#x8003;"></a>&#x53C2;&#x8003;</h3><p><a href="http://gityuan.com/2019/06/22/flutter_booting/" target="_blank" rel="external">&#x6DF1;&#x5165;&#x7406;&#x89E3;Flutter&#x5F15;&#x64CE;&#x542F;&#x52A8;</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/09/01/flutter-booting/" data-id="cknufq8qs0053ucqypdu1ci05" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2020/09/01/flutter-thread-model/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Flutter线程模型
        
      </div>
    </a>
  
  
    <a href="/2020/03/26/AndroidTransactionTooLargeException/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">TransactionTooLargeException问题分析</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Android/">Android</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Flutter/">Flutter</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java/">Java</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Network/">Network</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/AIDL/">AIDL</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Android/">Android</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Bitmap/">Bitmap</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Canvas/">Canvas</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ClassLoader/">ClassLoader</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Dart/">Dart</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HTTP/">HTTP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HttpClient/">HttpClient</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HttpResponseCache/">HttpResponseCache</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HttpURLConnection/">HttpURLConnection</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/IPC/">IPC</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/IntentFlag/">IntentFlag</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JVM/">JVM</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java/">Java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java基础/">Java基础</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java并发/">Java并发</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Network/">Network</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/View/">View</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/WebView/">WebView</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/android-sharedUserId/">android:sharedUserId</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/cache/">cache</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/launchmode/">launchmode</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/okhttp/">okhttp</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/push/">push</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/事件分发/">事件分发</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/内存泄露/">内存泄露</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/图片加载/">图片加载</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/基本数据类型/">基本数据类型</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/开源库/">开源库</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/消息机制/">消息机制</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/移位操作符/">移位操作符</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/网络/">网络</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/网络加载/">网络加载</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/网络库/">网络库</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/自定义View/">自定义View</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/阻塞队列/">阻塞队列</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/AIDL/" style="font-size: 10px;">AIDL</a> <a href="/tags/Android/" style="font-size: 20px;">Android</a> <a href="/tags/Bitmap/" style="font-size: 10px;">Bitmap</a> <a href="/tags/Canvas/" style="font-size: 10px;">Canvas</a> <a href="/tags/ClassLoader/" style="font-size: 10px;">ClassLoader</a> <a href="/tags/Dart/" style="font-size: 10px;">Dart</a> <a href="/tags/HTTP/" style="font-size: 12.5px;">HTTP</a> <a href="/tags/HttpClient/" style="font-size: 10px;">HttpClient</a> <a href="/tags/HttpResponseCache/" style="font-size: 10px;">HttpResponseCache</a> <a href="/tags/HttpURLConnection/" style="font-size: 10px;">HttpURLConnection</a> <a href="/tags/IPC/" style="font-size: 10px;">IPC</a> <a href="/tags/IntentFlag/" style="font-size: 10px;">IntentFlag</a> <a href="/tags/JVM/" style="font-size: 10px;">JVM</a> <a href="/tags/Java/" style="font-size: 15px;">Java</a> <a href="/tags/Java基础/" style="font-size: 10px;">Java基础</a> <a href="/tags/Java并发/" style="font-size: 12.5px;">Java并发</a> <a href="/tags/Network/" style="font-size: 10px;">Network</a> <a href="/tags/View/" style="font-size: 12.5px;">View</a> <a href="/tags/WebView/" style="font-size: 10px;">WebView</a> <a href="/tags/android-sharedUserId/" style="font-size: 10px;">android:sharedUserId</a> <a href="/tags/cache/" style="font-size: 10px;">cache</a> <a href="/tags/launchmode/" style="font-size: 10px;">launchmode</a> <a href="/tags/okhttp/" style="font-size: 10px;">okhttp</a> <a href="/tags/push/" style="font-size: 10px;">push</a> <a href="/tags/事件分发/" style="font-size: 10px;">事件分发</a> <a href="/tags/内存泄露/" style="font-size: 10px;">内存泄露</a> <a href="/tags/图片加载/" style="font-size: 12.5px;">图片加载</a> <a href="/tags/基本数据类型/" style="font-size: 10px;">基本数据类型</a> <a href="/tags/开源库/" style="font-size: 17.5px;">开源库</a> <a href="/tags/消息机制/" style="font-size: 10px;">消息机制</a> <a href="/tags/移位操作符/" style="font-size: 10px;">移位操作符</a> <a href="/tags/网络/" style="font-size: 10px;">网络</a> <a href="/tags/网络加载/" style="font-size: 10px;">网络加载</a> <a href="/tags/网络库/" style="font-size: 10px;">网络库</a> <a href="/tags/自定义View/" style="font-size: 10px;">自定义View</a> <a href="/tags/阻塞队列/" style="font-size: 10px;">阻塞队列</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/04/">April 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">September 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">March 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">October 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">June 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">March 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">December 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">July 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">May 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">September 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">August 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">June 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">April 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">March 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">January 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">December 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">November 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">August 2016</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2021/04/19/Activity黑屏分析/">Activity黑屏分析</a>
          </li>
        
          <li>
            <a href="/2021/04/10/深入理解Binder/">深入理解Binder</a>
          </li>
        
          <li>
            <a href="/2020/09/01/dart-async/">Dart的单线程模型&amp;异步操作</a>
          </li>
        
          <li>
            <a href="/2020/09/01/flutter-thread-model/">Flutter线程模型</a>
          </li>
        
          <li>
            <a href="/2020/09/01/flutter-booting/">深入理解Flutter引擎启动</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2021 xiongcen<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>